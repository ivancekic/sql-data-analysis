"REM WORKSPACETAB0","Kepu knjiga last bez 73 i 74.sql",,374
Select sum( ZADUZENJE ) zad
     , sum( RAZDUZENJE ) razd

     , sum( ZADUZENJE - RAZDUZENJE ) stanje
from
(
        select dodatni_tip dodtip, broj_dok brd, god_dok god, vrsta_dok vrd,
               TO_CHAR(datum_dok,'DD.MM.YY') DATUM,
               --------------------------------------------------------------------------------------------
--               datum_dok,
               datum_unosa,
               --------------------------------------------------------------------------------------------
               NVL(
               CASE WHEN zaduzenje<>0 and tip_dok in (10) and vrsta_dok not in ('4')  THEN
                       (
                        select 'KVPC:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)
                          from vezni_dok VDX, DOKUMENT DX
                         where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                           AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                           AND VDX.ZA_GODINA    = DX.GODINA
                           AND VDX.vrsta_dok = vr_dok
                           and VDX.broj_dok  = br_dok
                           and VDX.godina    = GOD_DOK
                          and za_vrsta_dok = '85'

                       )
                    WHEN zaduzenje <> 0 and vrsta_dok in ('73') THEN
                           'KVPC:'||dokument
                    WHEN vrsta_dok = '13' THEN
                       'POVR:'||dokument
                    WHEN vrsta_dok = '4' THEN
                       'STPR:'||dokument
                    ELSE
                       dokument
               END,'-') dokument,
               --------------------------------------------------------------------------------------------
               naziv_partnera||po_dokumentu naziv_partnera,
               --------------------------------------------------------------------------------------------
               case when NVL(zaduzenje,0) + NVL(rabat,0) <> 0 then
                         nvl(zaduzenje,0) + nvl(PDV_NA_ZADUZENJE,0)
                    else
                       0
               end zaduzenje,
               --------------------------------------------------------------------------------------------
               case when NVL(razduzenje,0) <> 0 then
                         nvl(razduzenje,0) + nvl(rabat,0) + nvl(PDV_RAZDUZENJE,0)
                    else
                       0
               end razduzenje


--	     case when zaduzenje + rabat <> 0 then
--	               zaduzenje + rabat
--	          else
--	             null
--	     end zaduzenje,
--	     case when razduzenje <> 0 then
--	             razduzenje+rabat
--	          else
--	             null
--	     end razduzenje

               --------------------------------------------------------------------------------------------
          from (

        select
               org_podaci.dodatni_tip,
               d.org_deo,
               d.vrsta_dok,vd.naziv vd_naziv,
               d.tip_dok, nf.naziv tip_naziv,
               d.broj_dok,d.broj_dok1,d.godina,
               D.GODINA GOD_DOK,
               D.BROJ_DOK BR_DOK,
               D.VRSTA_DOK VR_DOK,
               d.datum_dok,d.datum_unosa,
               to_char(d.datum_dok,'dd.mm.yyyy') datum,
               D.ORG_DEO||'-'||d.broj_dok1||'/'||substr(d.godina,3,4) dokument,
               case when d.vrsta_dok = (11) and d.tip_dok in (23,238) then
                         'Int.Otprema'
                    when d.vrsta_dok = (3) and d.tip_dok in (115) then
                         'Int.Prijem'
                    when d.vrsta_dok in (70) then
                         'Medjuskl.Izl'
                    when d.vrsta_dok in (71) then
                         'Medjuskl.Ul'
                    when d.vrsta_dok = (12) and d.tip_dok = 23 then
                         'STORNO INT.OTPR.'
                    when d.vrsta_dok in (21) then
                         'POCETNO STANJE'
                    when d.vrsta_dok in (90) then
                         'NIVEL.'
                    when d.vrsta_dok not in (80) then
                         SUBSTR(pp.naziv,1,19)
                    else
                         'NIVELACIJA'
               end naziv_partnera,
               CASE WHEN D.VRSTA_DOK = 3 AND D.TIP_DOK = 10 THEN
                         (select ' (OTPR: '||TRIM(za_broj_dok)||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 73 THEN
                         (select ' ('||TRIM(za_broj_dok)||'/'||za_godina||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 90 THEN
                         (select '(UZROK:'
                                   ||
                                   case when dp.vrsta_dok = 13 then
                                            'POVR.'
                                        WHEN DP.VRSTA_dok = 12 then
                                            'STOR.'
                                        ELSE
                                             ' '
                                   END
                                   ||dp.org_deo||'-'||dp.broj_dok1||'/'||SUBSTR(za_godina,3,2)||')'
                            from vezni_dok VDP, DOKUMENT DP

                           where VDP.vrsta_dok    = d.vrsta_dok
                             and VDP.broj_dok     = d.broj_dok
                             and VDP.godina       = d.godina
                             AND VDP.ZA_vrsta_dok = dp.vrsta_dok
                             and vdp.za_godina    = dp.godina
                             and vdp.za_broj_dok  = dp.broj_dok)
                    WHEN D.VRSTA_DOK = 13 THEN
                         (
                            select
                                   '(RN-OT:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)||')'
                              from vezni_dok VDX, DOKUMENT DX
                             where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                               AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                               AND VDX.ZA_GODINA    = DX.GODINA
                               AND VDX.vrsta_dok    = d.vrsta_dok
                               and VDX.broj_dok     = d.broj_dok
                               and VDX.godina       = d.godina
                              and za_vrsta_dok = '11'
                         )
                    ELSE

                    NULL
               END
               po_dokumentu,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(
--	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1 *
	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena *
	                                  PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok)
	                                 ,0)
		                              ,
		                              2
--		                              DECODE(D.PPARTNER, '206',2
--		                                               , '172',2
--		                                               , 4
--		                                    )
	                             )
                       ,0)
                       *
	                   (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK in ('80','90') THEN 0 ELSE 1 END)
                        +
	                   (case when d.vrsta_dok in (80) then
	                              ROUND(st.kolicina*(NVL(st.cena1*st.faktor,0)-NVL(st.cena,0)),2)
	                         WHEN d.vrsta_dok in (90) then
	                              case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
	                                        nvl(
	                	                            (
	                	                             	select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in (13) then -1
	                	                                	     	 when vd3.za_vrsta_dok in (11,12,31,74) then 1
	                	                               		    else 1
	                	                               		    end
	                	                               		   )
	                     						 	 	from vezni_dok vd3
											     	 	where vd3.vrsta_dok = d.vrsta_dok and vd3.godina = d.godina and vd3.broj_dok  = d.broj_dok
											              and vd3.za_vrsta_dok in(11,12,13,31,74,3)
											        )
												,-1)
                                  ELSE
	                                     1
	                              END
	                             *
	                              ROUND(st.kolicina*(st.cena-NVL(st.cena1*st.faktor,0)),2)
	                   else
	                           0
	                   end
	                   )
                   )
                                                                                                                                         ZADUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena*st.rabat/100
                                 * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1),0),2) ,0 ))
                                                                                                                                         RABAT,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                                 * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                                ,0)
                            ,2)
                      ,0)
                   )
                                                                                                                                         RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum( --ROUND(
                    CASE WHEN &nPrikaziPDV = 0 Then
                              0
                    ELSE
                        (
                         NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                                       * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                                      ,0)
                                  ,2)
                             ,0)
                             --- RAZDUZENJE KRAJ
                       +
                         NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*ST.CENA
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                      ,0)
                                   ,2)
                             ,0 )
                             --- RABAT KRAJ
                         )
                       *
                                 -- posebno obradjeno kad nije unipasan pdv na stavkama
                                 -- po novom treba prikazti pdv za svaku vrstu dokumenta
                                 nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                    END
                    --,2)
                   )
                                                                                                                                         PDV_RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               CASE WHEN &nPrikaziPDV = 1 then
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1 *
                                           PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok)
                                       ,0)
                                       * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                                   ,2)
                              ,0)
                      *
                      (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                                 0
                       ELSE
                                 1
                       END)
                      +
                       case when d.vrsta_dok in (80) then
                                 ROUND(st.kolicina*(NVL(st.cena1*ST.FAKTOR,0)-NVL(st.cena,0)),2)
                                 * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                            WHEN d.vrsta_dok in (90) then
                                 case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                                           nvl( (select case when vd3.za_vrsta_dok is null then -1 else 1 end
                     						     from vezni_dok vd3
										         where vd3.vrsta_dok = d.vrsta_dok
 										           and vd3.godina    = d.godina
										           and vd3.broj_dok  = d.broj_dok
--										           and vd3.za_vrsta_dok = 11)
										           and vd3.za_vrsta_dok in(11,12,13,31,74,5)
										         )
										       , -1)
                                 else
                                        1
                                 end
                                *
                                 ROUND(st.kolicina *( st.cena - NVL(st.cena1*st.faktor,0))
                                        * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                                      ,2)
                       else
                           0
                       end
                       )
---------------------- rabat
                     +
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                                       * st.rabat/100
                                       * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                       * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                                       ,0)
                                    ,2)
                              ,0 )
                         )
                     +
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                                        (Case When st.valuta <> 'YUD' Then
                                            (Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                                  (Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                                   Else
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                                             Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                                   End
                                                  )
                                                  When D.Vrsta_Dok != '73' Then
                                                       round(nvl(st.cena,0) *
                                                       Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                              End
                                            )
                                         Else
                                             st.cena
                                         End
                                        )
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                       ,0)
                                   ,2)
                              ,0)
                  )
 -- prikaz bez pdv
               ELSE
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                                        (Case When st.valuta <> 'YUD' Then
                                            (Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                                  (Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                                   Else
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                                             Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                                   End
                                                  )
                                                  When D.Vrsta_Dok != '73' Then
                                                       round(nvl(st.cena,0) *
                                                       Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                             End
                                            )
                                         Else
                                             st.cena
                                         End
                                        )
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                      ,0)
                                   ,2)
                             ,0 )
                         )
               END                                                                                                                        PDV_NA_ZADUZENJE
               ----------------------------------------------------------------------------------------------------------------------------------------------
          from dokument d,(SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
                                   CENA1,Z_TROSKOVI
                             FROM STAVKA_DOK

                            UNION ALL

                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
                               AND VDP.GODINA    = STP.GODINA
                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
                               AND VDP.ZA_VRSTA_DOK = '90'
                               AND STP.CENA<>STP.CENA1) ST
                         , proizvod p, poslovni_partner pp, organizacioni_deo orgd, vrsta_dok vd, nacin_fakt nf, org_deo_osn_podaci org_podaci
         where d.vrsta_dok = st.vrsta_dok
           and d.godina    = st.godina
           and d.broj_dok  = st.broj_dok
           and d.vrsta_dok = vd.vrsta
           and d.tip_dok   = nf.tip
           and st.proizvod = p.sifra
           and d.ppartner  = pp.sifra (+)
           and d.org_deo   = orgd.id
           and d.vrsta_dok not in (2,9,10,61,62)
           and orgd.id     = org_podaci.org_deo
           and p.tip_proizvoda not in (8)
           and d.org_deo   = &vZa_Magacin
           and d.datum_dok between  &DatumPocetnogStanja and &dDatumDo --to_date('31.12.'||to_char(dDatumOd,'yyyy'),'dd.mm.yyyy')
           AND D.STATUS > 0
--AND D.VRSTA_DOK = 90
        group by  d.org_deo,org_podaci.dodatni_tip,
                  d.vrsta_dok,vd.naziv ,
                  d.tip_dok, nf.naziv ,
                  d.broj_dok,d.broj_dok1,d.godina,
                  d.datum_dok,d.datum_unosa,
                  to_char(d.datum_dok,'dd.mm.yyyy') ,
                  d.org_deo||'-'||d.broj_dok1||'/'||d.godina ,
                  pp.naziv
        order by d.org_deo,d.datum_dok,d.datum_unosa)
)
"REM WORKSPACETAB1","Kepu knjiga stanje last.sql",,332

select k.zad KEPU_ZAD, k.razd KEPU_RAZD, k.stanje KEPU_STANJE
     , s.ST ZAL_STANJE, s.VRED ZAL_VRED, s.KONT ZAL_KONTROLA

     , k.stanje - s.VRED RAZL_KEPU_ZAL
from
(
	Select sum( ZADUZENJE ) zad
	     , sum( RAZDUZENJE ) razd
	     , sum( ZADUZENJE - RAZDUZENJE ) stanje
	from
	(
        select dodatni_tip,broj_dok,god_dok,vrsta_dok,
               TO_CHAR(datum_dok,'DD.MM.YY') DATUM,
               --------------------------------------------------------------------------------------------
               datum_dok,
               --------------------------------------------------------------------------------------------
               NVL(
               CASE WHEN zaduzenje<>0 and tip_dok in (10) and vrsta_dok not in ('4')  THEN
                       (
                        select 'KVPC:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)
                          from vezni_dok VDX, DOKUMENT DX
                         where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                           AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                           AND VDX.ZA_GODINA    = DX.GODINA
                           AND VDX.vrsta_dok = vr_dok
                           and VDX.broj_dok  = br_dok
                           and VDX.godina    = GOD_DOK
                          and za_vrsta_dok = '85'

                       )
                    WHEN zaduzenje <> 0 and vrsta_dok in ('73') THEN
                           'KVPC:'||dokument
                    WHEN vrsta_dok = '13' THEN
                       'POVR:'||dokument
                    WHEN vrsta_dok = '4' THEN
                       'STPR:'||dokument
                    ELSE
                       dokument
               END,'-') dokument,
               --------------------------------------------------------------------------------------------
               naziv_partnera||po_dokumentu naziv_partnera,
               --------------------------------------------------------------------------------------------
               case when NVL(zaduzenje,0) + NVL(rabat,0) <> 0 then
                         nvl(zaduzenje,0) + nvl(PDV_NA_ZADUZENJE,0)
                    else
                       0
               end zaduzenje,
               --------------------------------------------------------------------------------------------
               case when NVL(razduzenje,0) <> 0 then
                         nvl(razduzenje,0) + nvl(rabat,0) + nvl(PDV_RAZDUZENJE,0)
                    else
                       0
               end razduzenje
               --------------------------------------------------------------------------------------------
          from (

        select
               org_podaci.dodatni_tip,
               d.org_deo,
               d.vrsta_dok,vd.naziv vd_naziv,
               d.tip_dok, nf.naziv tip_naziv,
               d.broj_dok,d.broj_dok1,d.godina,
               D.GODINA GOD_DOK,
               D.BROJ_DOK BR_DOK,
               D.VRSTA_DOK VR_DOK,
               d.datum_dok,d.datum_unosa,
               to_char(d.datum_dok,'dd.mm.yyyy') datum,
               D.ORG_DEO||'-'||d.broj_dok1||'/'||substr(d.godina,3,4) dokument,
               case when d.vrsta_dok = (11) and d.tip_dok in (23,238) then
                         'Int.Otprema'
                    when d.vrsta_dok = (3) and d.tip_dok in (115) then
                         'Int.Prijem'
                    when d.vrsta_dok in (70) then
                         'Medjuskl.Izl'
                    when d.vrsta_dok in (71) then
                         'Medjuskl.Ul'
                    when d.vrsta_dok = (12) and d.tip_dok = 23 then
                         'STORNO INT.OTPR.'
                    when d.vrsta_dok in (21) then
                         'POCETNO STANJE'
                    when d.vrsta_dok in ('90') then
                         'NIVEL.'
                    when d.vrsta_dok not in ('80') then
                         SUBSTR(pp.naziv,1,19)
                    else
                         'NIVELACIJA'
               end naziv_partnera,
               CASE WHEN D.VRSTA_DOK = 3 AND D.TIP_DOK = 10 THEN
                         (select ' (OTPR: '||TRIM(za_broj_dok)||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 73 THEN
                         (select ' ('||TRIM(za_broj_dok)||'/'||za_godina||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = '90' THEN
                         (select '(UZROK:'
                                   ||
                                   case when dp.vrsta_dok = 13 then
                                            'POVR.'
                                        WHEN DP.VRSTA_dok = 12 then
                                            'STOR.'
                                        ELSE
                                             ' '
                                   END
                                   ||dp.org_deo||'-'||dp.broj_dok1||'/'||SUBSTR(za_godina,3,2)||')'
                            from vezni_dok VDP, DOKUMENT DP

                           where VDP.vrsta_dok    = d.vrsta_dok
                             and VDP.broj_dok     = d.broj_dok
                             and VDP.godina       = d.godina
                             AND VDP.ZA_vrsta_dok = dp.vrsta_dok
                             and vdp.za_godina    = dp.godina
                             and vdp.za_broj_dok  = dp.broj_dok)
                    WHEN D.VRSTA_DOK = 13 THEN
                         (
                            select
                                   '(RN-OT:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)||')'
                              from vezni_dok VDX, DOKUMENT DX
                             where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                               AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                               AND VDX.ZA_GODINA    = DX.GODINA
                               AND VDX.vrsta_dok    = d.vrsta_dok
                               and VDX.broj_dok     = d.broj_dok
                               and VDX.godina       = d.godina
                              and za_vrsta_dok = '11'
                         )
                    ELSE

                    NULL
               END
               po_dokumentu,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(
--	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1
--	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*round(ST.FAKTOR*st.cena1,4)
--	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*
--	                                      round(ST.FAKTOR*st.cena1,4)
--	                                      ( case when d.vrsta_Dok = '5' then
--	                                            st.cena - round(ST.FAKTOR*st.cena1,4)
--	                                        else
--	                                            round(ST.FAKTOR*st.cena1,4)
--	                                        end
--	                                      )
	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena
	                                  *
	                                  PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok)
	                                 ,0)
	                              ,
--	                              DECODE(D.PPARTNER, '206',2
--	                                               , '172',2
--	                                               , 4
--	                                    )
                                  2
	                             )
                       ,0)*

                   (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                               0
                         ELSE
                               1
                    END)
                            +
                    case when d.vrsta_dok in ('80') then
                              ROUND(st.kolicina*(NVL(st.cena1,0)-NVL(st.cena,0)),2)
                         WHEN d.vrsta_dok in ('90') then
                              case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                                        nvl(
                	                            (
                	                             	select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in (13) then -1
                	                                	     	 when vd3.za_vrsta_dok in (11,12,31,74) then 1
                	                               		    else 1
                	                               		    end
                	                               		   )
                     						 	 	from vezni_dok vd3
										     	 	where vd3.vrsta_dok = d.vrsta_dok
										              and vd3.godina    = d.godina
										              and vd3.broj_dok  = d.broj_dok
										              and vd3.za_vrsta_dok in(11,12,13,31,74)
										        )
											,-1)

                                  ELSE
                                     1
                             END
                             *
                             ROUND(st.kolicina*(st.cena-NVL(st.cena1*st.faktor,0)),2)
                        else
                           0
                   end
                   )                                                                                                                     ZADUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
--               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)
--                   *round(ST.FAKTOR*st.cena1,4)
                                *st.cena
                                *st.rabat/100
                                *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1),0),2) ,0 ))               RABAT,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                             * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                            ,0)
                   ,2),0)
                   )                                                                                                                     RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               0                                                                                                                         PDV_RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               CASE WHEN &nPrikaziPDV = 1 then
               0
 -- prikaz bez pdv
               ELSE
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                      ,0)
                                   ,2)
                             ,0 )
                         )
--               0
               END                                                                                                                        PDV_NA_ZADUZENJE
               ----------------------------------------------------------------------------------------------------------------------------------------------
          from dokument d,(SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
                                   CENA1,Z_TROSKOVI
                             FROM STAVKA_DOK

                            UNION ALL

                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
                               AND VDP.GODINA    = STP.GODINA
                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
                               AND VDP.ZA_VRSTA_DOK = '90'
                               AND STP.CENA<>round(STP.CENA1*stp.faktor,4)) ST
                         , proizvod p, poslovni_partner pp, organizacioni_deo orgd, vrsta_dok vd, nacin_fakt nf, org_deo_osn_podaci org_podaci
         where d.vrsta_dok = st.vrsta_dok
           and d.godina    = st.godina
           and d.broj_dok  = st.broj_dok
           and d.vrsta_dok = vd.vrsta
           and d.tip_dok   = nf.tip
           and st.proizvod = p.sifra
           and d.ppartner  = pp.sifra (+)
           and d.org_deo   = orgd.id
           and d.vrsta_dok not in (2,9,10,61,62)
           and orgd.id     = org_podaci.org_deo
           and p.tip_proizvoda not in (8)
           and d.org_deo   = &vZa_Magacin
           and d.datum_dok between  &DatumPocetnogStanja and &dDatumDo --to_date('31.12.'||to_char(dDatumOd,'yyyy'),'dd.mm.yyyy')
--           AND sT.proizvod NOT in ('4510','4539')
           AND D.STATUS > 0

        group by  d.org_deo,org_podaci.dodatni_tip,
                  d.vrsta_dok,vd.naziv ,
                  d.tip_dok, nf.naziv ,
                  d.broj_dok,d.broj_dok1,d.godina,
                  d.datum_dok,d.datum_unosa,
                  to_char(d.datum_dok,'dd.mm.yyyy') ,
                  d.org_deo||'-'||d.broj_dok1||'/'||d.godina ,
                  pp.naziv
        order by d.org_deo,d.datum_dok,d.datum_unosa)
	)
) k
,
(
	select sum(STANJE) st
	     , sum(VREDNOST) vred
	     , sum(U_KONTROLI) kont
	from
	(
	         Select Stavka_dok.Proizvod, Proizvod.posebna_grupa,
	                round(Sum(NVL(decode(dokument.tip_dok,14,Kolicina,realizovano)*Faktor

	                                * case when dokument.vrsta_dok = '90' then
	                                         0
	                                       else
	                                         K_ROBE
	                                  end

	                                ,0)),5) STANJE,

	                round(Sum(NVL(decode(dokument.tip_dok,14,Kolicina,realizovano)*Faktor*
	                   (CASE WHEN DOKUMENT.VRSTA_DOK = '80' THEN
	                         (STAVKA_DOK.CENA1-STAVKA_DOK.CENA)
	                        WHEN dokument.vrsta_dok  ='90' then
	                             ROUND((NVL(stavka_dok.cena,0)-NVL(stavka_dok.cena1,0)),2)
-- 0
	                    ELSE K_ROBE*(
--	                                     CASE WHEN DOKUMENT.VRSTA_DOK = 11 AND UPPER(ORGD.DODATNI_TIP) = 'VP2' THEN
--	                                             STAVKA_DOK.CENA1
--	                                          ELSE
--	                                             STAVKA_DOK.CENA1
--	                                     END
	                                             STAVKA_DOK.CENA1
	                                 )
	                END),0)),2) VREDNOST

	               , (select sum(kolicina*faktor)
	                   from dokument dx, stavka_dok stx
	                  where dx.vrsta_dok = stx.vrsta_dok and dx.broj_dok = stx.broj_dok and dx.godina = stx.godina
	                    and dx.vrsta_dok = 3
	                    and dx.tip_dok   = 10
	                    and dx.status in ('-8','-9') and dx.godina > 2008
	                    and stx.proizvod = stavka_dok.proizvod)
	                  u_kontroli

	               From Dokument,
	                    (SELECT  BROJ_DOK,
	                             VRSTA_DOK,
	                             GODINA,
	                             STAVKA,PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
	                       FROM STAVKA_DOK
--	                       WHERE STAVKA_DOK.proizvod NOT in ('4510','4539')
	                    ) Stavka_Dok,
	                    Proizvod,
	                    ORG_DEO_OSN_PODACI ORGD

	         Where Dokument.Vrsta_Dok = Stavka_Dok.Vrsta_Dok And
	               Dokument.Broj_Dok = Stavka_Dok.Broj_Dok And
	               Dokument.Godina = Stavka_Dok.Godina And
	               DOKUMENT.ORG_DEO = ORGD.ORG_DEO (+) AND
	               Dokument.Status > 0 And
	               dokument.datum_dok between  &DatumPocetnogStanja and &dDatumDo and

	               (Stavka_Dok.K_Robe != 0 OR DOKUMENT.VRSTA_DOK = '80') And
	               Dokument.Org_Deo = &vZa_Magacin And Proizvod.sifra=Stavka_dok.proizvod
	           and dokument.vrsta_dok not in (2,9,10,61,62)
	           and proizvod.tip_proizvoda not in (8)
	         Group By Stavka_dok.Proizvod,Proizvod.tip_proizvoda,Proizvod.posebna_grupa,Proizvod.grupa_proizvoda,Proizvod.naziv
	         Order By Proizvod.posebna_grupa,Stavka_dok.proizvod
	)
) s
"REM WORKSPACETAB2",Kepu_OD_old_zoki,,143
select sum(nvl(zaduzenje,0)) zad, sum(nvl(razduzenje,0)) razd
     , sum(nvl(zaduzenje,0) - nvl(razduzenje,0)) stanje
from
(
	select
	--TRUNC((MOD(ROWNUM-1,BrRedNaStranici)-ROWNUM)*(-1)/BrRedNaStranici,0)+1 STRANICA,
	--     ROWNUM RedBrStavke,
	     TO_CHAR(datum_dok,'DD.MM.YY') DATUM,
	     datum_dok,
--	     CASE WHEN zaduzenje<>0 and tip_dok in (10) THEN
--	             'KVPC: '||dokument
--	          ELSE
--	             dokument
--	     END dokument,
         broj_dok brd, godina god, vrsta_dok vrd,
         ORG_DEO||'-'||broj_dok1||'/'||substr(godina,3,4) dokument,
	     naziv_partnera||po_dokumentu naziv_partnera,
	     case when zaduzenje + rabat <> 0 then
	               zaduzenje + rabat
	          else
	             null
	     end zaduzenje,
	     case when razduzenje <> 0 then
	             razduzenje+rabat
	          else
	             null
	     end razduzenje
	from (
	        select
	               d.org_deo,
	               d.vrsta_dok,vd.naziv vd_naziv,
	               d.tip_dok, nf.naziv tip_naziv,
	               d.broj_dok,d.broj_dok1,d.godina,
	               d.datum_dok,d.datum_unosa,
	               to_char(d.datum_dok,'dd.mm.yyyy') datum,
	               d.broj_dok1||'/'||substr(d.godina,3,4) dokument,
	               case when d.vrsta_dok = (11) and d.tip_dok = 23 then
	                         'INTERNA OTPREMA'
	                    when d.vrsta_dok = (12) and d.tip_dok = 23 then
	                         'STORNO INT.OTPR.'
	                    when d.vrsta_dok in (21) then
	                         'POCETNO STANJE'
	                    when d.vrsta_dok not in (80) then
	                         pp.naziv
	                    else
	                       'NIVELACIJA'
	               end naziv_partnera,
	               (select ' (OTPR: '||TRIM(za_broj_dok)||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
	               po_dokumentu,
	--               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1
	               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena
	                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok),0),2)
	                   *
	                   (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
	                               0
	                         ELSE
	                               1
	                    END)
	                   +
	                   case when d.vrsta_dok in (80) then
	                             st.kolicina*(st.cena1-st.cena)
	                        WHEN d.vrsta_dok in ('90') then
	                             case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
	                                       nvl(
	               	                            (
	               	                             	select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in (13,5) then -1
	               	                                	     	 when vd3.za_vrsta_dok in (11,12,31,74) then 1
	               	                               		    else 1
	               	                               		    end
	               	                               		   )
	                    						 	 	from vezni_dok vd3
										     	 	where vd3.vrsta_dok = d.vrsta_dok
										              and vd3.godina    = d.godina
										              and vd3.broj_dok  = d.broj_dok
										              and vd3.za_vrsta_dok in(11,12,13,31,74)
										        )
											,-1)
	                                  ELSE
	                                     1
	                             END
	                             *
	                             ROUND(st.kolicina*(st.cena-NVL(st.cena1*st.faktor,0)),2)
	                   else
	                           0
	                   end
	                   )
	               zaduzenje,

	--               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena*st.rabat/100
	               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena*st.rabat/100
	                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1),0),2))
	               rabat,
	--               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena
	               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena
	                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok),0),2))
	               razduzenje

	          from dokument d,
	--          stavka_dok st,
	               (SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
	                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
	                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
	                                   CENA1,Z_TROSKOVI
	                             FROM STAVKA_DOK

	                            UNION ALL

	                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
	                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
	                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
	                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
	                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
	                               AND VDP.GODINA    = STP.GODINA
	                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
	                               AND VDP.ZA_VRSTA_DOK = '90'
	                               AND STP.CENA<>round(STP.CENA1*stp.faktor,4)
	               ) ST,
	               proizvod p, poslovni_partner pp, organizacioni_deo orgd, vrsta_dok vd, nacin_fakt nf, org_deo_osn_podaci org_podaci
	         where d.vrsta_dok = st.vrsta_dok
	           and d.godina    = st.godina
	           and d.broj_dok  = st.broj_dok
	           and d.vrsta_dok = vd.vrsta
	           and d.tip_dok   = nf.tip
	           and st.proizvod = p.sifra
	           and d.ppartner  = pp.sifra (+)
	           and d.org_deo   = orgd.id
	           and d.vrsta_dok not in (2,9,10,61,62)
	           and p.tip_proizvoda not in (8)
	           and orgd.id     = org_podaci.org_deo
	           and d.org_deo   like &vZa_Magacin
	           and d.datum_dok between  &DatumPocetnogStanja and &dDatumDo--to_date('31.12.'||to_char(&dDatumDo,'yyyy'),'dd.mm.yyyy')
	        group by  d.org_deo,
	                  d.vrsta_dok,vd.naziv ,
	                  d.tip_dok, nf.naziv ,
	                  d.broj_dok,d.broj_dok1,d.godina,
	                  d.datum_dok,d.datum_unosa,
	                  to_char(d.datum_dok,'dd.mm.yyyy') ,
	                  d.org_deo||'-'||d.broj_dok1||'/'||d.godina ,
	                  pp.naziv

	        order by d.org_deo,d.datum_dok,d.datum_unosa
	)
)
"REM WORKSPACETAB3",kepu_new_old,,507
Select kepu_n.DODTIP,kepu_n.BRD,kepu_n.GOD,kepu_n.VRD,kepu_n.DATUM,kepu_n.DATUM_UNOSA,kepu_n.DOKUMENT,kepu_n.NAZIV_PARTNERA
,kepu_n.ZADUZENJE,kepu_n.RAZDUZENJE
,kepu_o.ZADUZENJE,kepu_o.RAZDUZENJE

from
(
        select dodatni_tip dodtip, broj_dok brd, god_dok god, vrsta_dok vrd,
               TO_CHAR(datum_dok,'DD.MM.YY') DATUM,
               --------------------------------------------------------------------------------------------
--               datum_dok,
               datum_unosa,
               --------------------------------------------------------------------------------------------
               NVL(
               CASE WHEN zaduzenje<>0 and tip_dok in (10) and vrsta_dok not in ('4')  THEN
                       (
                        select 'KVPC:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)
                          from vezni_dok VDX, DOKUMENT DX
                         where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                           AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                           AND VDX.ZA_GODINA    = DX.GODINA
                           AND VDX.vrsta_dok = vr_dok
                           and VDX.broj_dok  = br_dok
                           and VDX.godina    = GOD_DOK
                          and za_vrsta_dok = '85'

                       )
                    WHEN zaduzenje <> 0 and vrsta_dok in ('73') THEN
                           'KVPC:'||dokument
                    WHEN vrsta_dok = '13' THEN
                       'POVR:'||dokument
                    WHEN vrsta_dok = '4' THEN
                       'STPR:'||dokument
                    ELSE
                       dokument
               END,'-') dokument,
               --------------------------------------------------------------------------------------------
               naziv_partnera||po_dokumentu naziv_partnera,
               --------------------------------------------------------------------------------------------
               case when NVL(zaduzenje,0) + NVL(rabat,0) <> 0 then
                         nvl(zaduzenje,0) + nvl(PDV_NA_ZADUZENJE,0)
                    else
                       0
               end zaduzenje,
               --------------------------------------------------------------------------------------------
               case when NVL(razduzenje,0) <> 0 then
                         nvl(razduzenje,0) + nvl(rabat,0) + nvl(PDV_RAZDUZENJE,0)
                    else
                       0
               end razduzenje
               --------------------------------------------------------------------------------------------
          from (

        select
               org_podaci.dodatni_tip,
               d.org_deo,
               d.vrsta_dok,vd.naziv vd_naziv,
               d.tip_dok, nf.naziv tip_naziv,
               d.broj_dok,d.broj_dok1,d.godina,
               D.GODINA GOD_DOK,
               D.BROJ_DOK BR_DOK,
               D.VRSTA_DOK VR_DOK,
               d.datum_dok,d.datum_unosa,
               to_char(d.datum_dok,'dd.mm.yyyy') datum,
               D.ORG_DEO||'-'||d.broj_dok1||'/'||substr(d.godina,3,4) dokument,
               case when d.vrsta_dok = (11) and d.tip_dok in (23,238) then
                         'Int.Otprema'
                    when d.vrsta_dok = (3) and d.tip_dok in (115) then
                         'Int.Prijem'
                    when d.vrsta_dok in (70) then
                         'Medjuskl.Izl'
                    when d.vrsta_dok in (71) then
                         'Medjuskl.Ul'
                    when d.vrsta_dok = (12) and d.tip_dok = 23 then
                         'STORNO INT.OTPR.'
                    when d.vrsta_dok in (21) then
                         'POCETNO STANJE'
                    when d.vrsta_dok in (90) then
                         'NIVEL.'
                    when d.vrsta_dok not in (80) then
                         SUBSTR(pp.naziv,1,19)
                    else
                         'NIVELACIJA'
               end naziv_partnera,
               CASE WHEN D.VRSTA_DOK = 3 AND D.TIP_DOK = 10 THEN
                         (select ' (OTPR: '||TRIM(za_broj_dok)||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 73 THEN
                         (select ' ('||TRIM(za_broj_dok)||'/'||za_godina||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 90 THEN
                         (select '(UZROK:'
                                   ||
                                   case when dp.vrsta_dok = 13 then
                                            'POVR.'
                                        WHEN DP.VRSTA_dok = 12 then
                                            'STOR.'
                                        ELSE
                                             ' '
                                   END
                                   ||dp.org_deo||'-'||dp.broj_dok1||'/'||SUBSTR(za_godina,3,2)||')'
                            from vezni_dok VDP, DOKUMENT DP

                           where VDP.vrsta_dok    = d.vrsta_dok
                             and VDP.broj_dok     = d.broj_dok
                             and VDP.godina       = d.godina
                             AND VDP.ZA_vrsta_dok = dp.vrsta_dok
                             and vdp.za_godina    = dp.godina
                             and vdp.za_broj_dok  = dp.broj_dok)
                    WHEN D.VRSTA_DOK = 13 THEN
                         (
                            select
                                   '(RN-OT:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)||')'
                              from vezni_dok VDX, DOKUMENT DX
                             where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                               AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                               AND VDX.ZA_GODINA    = DX.GODINA
                               AND VDX.vrsta_dok    = d.vrsta_dok
                               and VDX.broj_dok     = d.broj_dok
                               and VDX.godina       = d.godina
                              and za_vrsta_dok = '11'
                         )
                    ELSE

                    NULL
               END
               po_dokumentu,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(
--	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1 *
	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena *
	                                  PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok)
	                                 ,0)
		                              ,
		                              2
--		                              DECODE(D.PPARTNER, '206',2
--		                                               , '172',2
--		                                               , 4
--		                                    )
	                             )
                       ,0)
                       *
	                   (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN 0 ELSE 1 END)
                        +
	                   (case when d.vrsta_dok in (80) then
	                              ROUND(st.kolicina*(NVL(st.cena1*st.faktor,0)-NVL(st.cena,0)),2)
	                         WHEN d.vrsta_dok in (90) then
	                              case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
	                                        nvl(
	                	                            (
	                	                             	select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in (13) then -1
	                	                                	     	 when vd3.za_vrsta_dok in (11,12,31,74) then 1
	                	                               		    else 1
	                	                               		    end
	                	                               		   )
	                     						 	 	from vezni_dok vd3
											     	 	where vd3.vrsta_dok = d.vrsta_dok and vd3.godina = d.godina and vd3.broj_dok  = d.broj_dok
											              and vd3.za_vrsta_dok in(11,12,13,31,74,3)
											        )
												,-1)
                                  ELSE
	                                     1
	                              END
	                             *
	                              ROUND(st.kolicina*(st.cena-NVL(st.cena1*st.faktor,0)),2)
	                   else
	                           0
	                   end
	                   )
                   )
                                                                                                                                         ZADUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena*st.rabat/100
                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1),0),2) ,0 ))
                                                                                                                                         RABAT,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                                 * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                                ,0)
                            ,2)
                      ,0)
                   )
                                                                                                                                         RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum( --ROUND(
                    CASE WHEN &nPrikaziPDV = 0 Then
                              0
                    ELSE
                        (
                         NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                                       * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                                      ,0)
                                  ,2)
                             ,0)
                             --- RAZDUZENJE KRAJ
                       +
                         NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*ST.CENA
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                      ,0)
                                   ,2)
                             ,0 )
                             --- RABAT KRAJ
                         )
                       *
                                 -- posebno obradjeno kad nije unipasan pdv na stavkama
                                 -- po novom treba prikazti pdv za svaku vrstu dokumenta
                                 nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                    END
                    --,2)
                   )
                                                                                                                                         PDV_RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               CASE WHEN &nPrikaziPDV = 1 then
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1 *
                                           PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok)
                                       ,0)
                                       * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                                   ,2)
                              ,0)
                      *
                      (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                                 0
                       ELSE
                                 1
                       END)
                      +
                       case when d.vrsta_dok in (80) then
                                 ROUND(st.kolicina*(NVL(st.cena1*ST.FAKTOR,0)-NVL(st.cena,0)),2)
                                 * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                            WHEN d.vrsta_dok in (90) then
                                 case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                                           nvl( (select case when vd3.za_vrsta_dok is null then -1 else 1 end
                     						     from vezni_dok vd3
										         where vd3.vrsta_dok = d.vrsta_dok
 										           and vd3.godina    = d.godina
										           and vd3.broj_dok  = d.broj_dok
--										           and vd3.za_vrsta_dok = 11)
										           and vd3.za_vrsta_dok in(11,12,13,31,74,5)
										         )
										       , -1)
                                 else
                                        1
                                 end
                                *
                                 ROUND(st.kolicina *( st.cena - NVL(st.cena1*st.faktor,0))
                                        * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                                      ,2)
                       else
                           0
                       end
                       )
---------------------- rabat
                     +
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*st.cena
                                       * st.rabat/100
                                       * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                       * nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                                       ,0)
                                    ,2)
                              ,0 )
                         )
                     +
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                                        (Case When st.valuta <> 'YUD' Then
                                            (Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                                  (Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                                   Else
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                                             Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                                   End
                                                  )
                                                  When D.Vrsta_Dok != '73' Then
                                                       round(nvl(st.cena,0) *
                                                       Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                              End
                                            )
                                         Else
                                             st.cena
                                         End
                                        )
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                       ,0)
                                   ,2)
                              ,0)
                  )
 -- prikaz bez pdv
               ELSE
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                                        (Case When st.valuta <> 'YUD' Then
                                            (Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                                  (Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                                   Else
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                                             Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                                   End
                                                  )
                                                  When D.Vrsta_Dok != '73' Then
                                                       round(nvl(st.cena,0) *
                                                       Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                             End
                                            )
                                         Else
                                             st.cena
                                         End
                                        )
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                      ,0)
                                   ,2)
                             ,0 )
                         )
               END                                                                                                                        PDV_NA_ZADUZENJE
               ----------------------------------------------------------------------------------------------------------------------------------------------
          from dokument d,(SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
                                   CENA1,Z_TROSKOVI
                             FROM STAVKA_DOK

                            UNION ALL

                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
                               AND VDP.GODINA    = STP.GODINA
                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
                               AND VDP.ZA_VRSTA_DOK = '90'
                               AND STP.CENA<>STP.CENA1) ST
                         , proizvod p, poslovni_partner pp, organizacioni_deo orgd, vrsta_dok vd, nacin_fakt nf, org_deo_osn_podaci org_podaci
         where d.vrsta_dok = st.vrsta_dok
           and d.godina    = st.godina
           and d.broj_dok  = st.broj_dok
           and d.vrsta_dok = vd.vrsta
           and d.tip_dok   = nf.tip
           and st.proizvod = p.sifra
           and d.ppartner  = pp.sifra (+)
           and d.org_deo   = orgd.id
           and d.vrsta_dok not in (2,9,10,61,62)
           and orgd.id     = org_podaci.org_deo
           and p.tip_proizvoda not in (8)
           and d.org_deo   = &vZa_Magacin
           and d.datum_dok between  &DatumPocetnogStanja and &dDatumDo --to_date('31.12.'||to_char(dDatumOd,'yyyy'),'dd.mm.yyyy')
           AND D.STATUS > 0
--AND D.VRSTA_DOK = 90
        group by  d.org_deo,org_podaci.dodatni_tip,
                  d.vrsta_dok,vd.naziv ,
                  d.tip_dok, nf.naziv ,
                  d.broj_dok,d.broj_dok1,d.godina,
                  d.datum_dok,d.datum_unosa,
                  to_char(d.datum_dok,'dd.mm.yyyy') ,
                  d.org_deo||'-'||d.broj_dok1||'/'||d.godina ,
                  pp.naziv
        order by d.org_deo,d.datum_dok,d.datum_unosa)
) kepu_n
,
(
	select
	--TRUNC((MOD(ROWNUM-1,BrRedNaStranici)-ROWNUM)*(-1)/BrRedNaStranici,0)+1 STRANICA,
	--     ROWNUM RedBrStavke,
	     TO_CHAR(datum_dok,'DD.MM.YY') DATUM,
	     datum_dok,
--	     CASE WHEN zaduzenje<>0 and tip_dok in (10) THEN
--	             'KVPC: '||dokument
--	          ELSE
--	             dokument
--	     END dokument,
         broj_dok brd, godina god, vrsta_dok vrd,
         ORG_DEO||'-'||broj_dok1||'/'||substr(godina,3,4) dokument,
	     naziv_partnera||po_dokumentu naziv_partnera,
	     case when zaduzenje + rabat <> 0 then
	               zaduzenje + rabat
	          else
	             null
	     end zaduzenje,
	     case when razduzenje <> 0 then
	             razduzenje+rabat
	          else
	             null
	     end razduzenje
	from (
	        select
	               d.org_deo,
	               d.vrsta_dok,vd.naziv vd_naziv,
	               d.tip_dok, nf.naziv tip_naziv,
	               d.broj_dok,d.broj_dok1,d.godina,
	               d.datum_dok,d.datum_unosa,
	               to_char(d.datum_dok,'dd.mm.yyyy') datum,
	               d.broj_dok1||'/'||substr(d.godina,3,4) dokument,
	               case when d.vrsta_dok = (11) and d.tip_dok = 23 then
	                         'INTERNA OTPREMA'
	                    when d.vrsta_dok = (12) and d.tip_dok = 23 then
	                         'STORNO INT.OTPR.'
	                    when d.vrsta_dok in (21) then
	                         'POCETNO STANJE'
	                    when d.vrsta_dok not in (80) then
	                         pp.naziv
	                    else
	                       'NIVELACIJA'
	               end naziv_partnera,
	               (select ' (OTPR: '||TRIM(za_broj_dok)||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
	               po_dokumentu,
	--               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1
	               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena
	                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok),0),2)
	                   *
	                   (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
	                               0
	                         ELSE
	                               1
	                    END)
	                   +
	                   case when d.vrsta_dok in (80) then
	                             st.kolicina*(st.cena1-st.cena)
	                        WHEN d.vrsta_dok in ('90') then
	                             case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
	                                       nvl(
	               	                            (
	               	                             	select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in (13,5) then -1
	               	                                	     	 when vd3.za_vrsta_dok in (11,12,31,74) then 1
	               	                               		    else 1
	               	                               		    end
	               	                               		   )
	                    						 	 	from vezni_dok vd3
										     	 	where vd3.vrsta_dok = d.vrsta_dok
										              and vd3.godina    = d.godina
										              and vd3.broj_dok  = d.broj_dok
										              and vd3.za_vrsta_dok in(11,12,13,31,74)
										        )
											,-1)
	                                  ELSE
	                                     1
	                             END
	                             *
	                             ROUND(st.kolicina*(st.cena-NVL(st.cena1*st.faktor,0)),2)
	                   else
	                           0
	                   end
	                   )
	               zaduzenje,

	--               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena*st.rabat/100
	               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena*st.rabat/100
	                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1),0),2))
	               rabat,
	--               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena
	               sum(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena
	                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok),0),2))
	               razduzenje

	          from dokument d,
	--          stavka_dok st,
	               (SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
	                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
	                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
	                                   CENA1,Z_TROSKOVI
	                             FROM STAVKA_DOK

	                            UNION ALL

	                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
	                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
	                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
	                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
	                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
	                               AND VDP.GODINA    = STP.GODINA
	                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
	                               AND VDP.ZA_VRSTA_DOK = '90'
	                               AND STP.CENA<>round(STP.CENA1*stp.faktor,4)
	               ) ST,
	               proizvod p, poslovni_partner pp, organizacioni_deo orgd, vrsta_dok vd, nacin_fakt nf, org_deo_osn_podaci org_podaci
	         where d.vrsta_dok = st.vrsta_dok
	           and d.godina    = st.godina
	           and d.broj_dok  = st.broj_dok
	           and d.vrsta_dok = vd.vrsta
	           and d.tip_dok   = nf.tip
	           and st.proizvod = p.sifra
	           and d.ppartner  = pp.sifra (+)
	           and d.org_deo   = orgd.id
	           and d.vrsta_dok not in (2,9,10,61,62)
	           and p.tip_proizvoda not in (8)
	           and orgd.id     = org_podaci.org_deo
	           and d.org_deo   like &vZa_Magacin
	           and d.datum_dok between  &DatumPocetnogStanja and &dDatumDo--to_date('31.12.'||to_char(&dDatumDo,'yyyy'),'dd.mm.yyyy')
	        group by  d.org_deo,
	                  d.vrsta_dok,vd.naziv ,
	                  d.tip_dok, nf.naziv ,
	                  d.broj_dok,d.broj_dok1,d.godina,
	                  d.datum_dok,d.datum_unosa,
	                  to_char(d.datum_dok,'dd.mm.yyyy') ,
	                  d.org_deo||'-'||d.broj_dok1||'/'||d.godina ,
	                  pp.naziv

	        order by d.org_deo,d.datum_dok,d.datum_unosa
	)
)kepu_o
where kepu_n.BRD=kepu_O.brd
  and kepu_n.GOD=kepu_o.GOD
  and kepu_n.VRD=kepu_o.VRD
and nvl(kepu_n.ZADUZENJE,0)<>nvl(kepu_o.ZADUZENJE,0)
and nvl(kepu_n.RAZDUZENJE,0)<>nvl(kepu_o.RAZDUZENJE,0)
"REM WORKSPACETAB4",kepu_old_dodate_vrste,,275
select sum(zaduzenje), sum(razduzenje)
, sum(zaduzenje-razduzenje)
from
(
        select dodatni_tip,broj_dok,god_dok,vrsta_dok,
               --------------------------------------------------------------------------------------------
--               TRUNC((MOD(ROWNUM-1,BrRedNaStranici)-ROWNUM)*(-1)/BrRedNaStranici,0)+1 STRANICA,
               --------------------------------------------------------------------------------------------
               ROWNUM RedBrStavke,
               --------------------------------------------------------------------------------------------
               TO_CHAR(datum_dok,'DD.MM.YY') DATUM,
               --------------------------------------------------------------------------------------------
               datum_dok,
               --------------------------------------------------------------------------------------------
               NVL(
               CASE WHEN zaduzenje<>0 and tip_dok in (10) and vrsta_dok not in ('4')  THEN
                       (
                        select 'KVPC:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)
                          from vezni_dok VDX, DOKUMENT DX
                         where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                           AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                           AND VDX.ZA_GODINA    = DX.GODINA
                           AND VDX.vrsta_dok = vr_dok
                           and VDX.broj_dok  = br_dok
                           and VDX.godina    = GOD_DOK
                          and za_vrsta_dok = '85'

                       )
                    WHEN zaduzenje <> 0 and vrsta_dok in ('73') THEN
                           'KVPC:'||dokument
                    WHEN vrsta_dok = '13' THEN
                       'POVR:'||dokument
                    WHEN vrsta_dok = '4' THEN
                       'STPR:'||dokument
                    ELSE
                       dokument
               END,'-') dokument,
               --------------------------------------------------------------------------------------------
               naziv_partnera||po_dokumentu naziv_partnera,
               --------------------------------------------------------------------------------------------
               case when NVL(zaduzenje,0) + NVL(rabat,0) <> 0 then
                         nvl(zaduzenje,0) + nvl(rabat,0)
                    else
                       0
               end zaduzenje,
               --------------------------------------------------------------------------------------------
               case when NVL(razduzenje,0) <> 0 then
                       nvl(razduzenje,0) + nvl(rabat,0)
                    else
                       0
               end razduzenje
               --------------------------------------------------------------------------------------------
--               case when zaduzenje + rabat <> 0 then
--                         zaduzenje + rabat
--                    else
--                       null
--               end zaduzenje,
--               --------------------------------------------------------------------------------------------
--               case when razduzenje <> 0 then
--                       razduzenje + rabat
--                    else
--                       null
--               end razduzenje
               --------------------------------------------------------------------------------------------

          from (

        select
               org_podaci.dodatni_tip,
               d.org_deo,
               d.vrsta_dok,vd.naziv vd_naziv,
               d.tip_dok, nf.naziv tip_naziv,
               d.broj_dok,d.broj_dok1,d.godina,
               D.GODINA GOD_DOK,
               D.BROJ_DOK BR_DOK,
               D.VRSTA_DOK VR_DOK,
               d.datum_dok,d.datum_unosa,
               to_char(d.datum_dok,'dd.mm.yyyy') datum,
               D.ORG_DEO||'-'||d.broj_dok1||'/'||substr(d.godina,3,4) dokument,
               case when d.vrsta_dok = (11) and d.tip_dok in (23,238) then
                         'Int.Otprema'
                    when d.vrsta_dok = (3) and d.tip_dok in (115) then
                         'Int.Prijem'
                    when d.vrsta_dok in (70) then
                         'Medjuskl.Izl'
                    when d.vrsta_dok in (71) then
                         'Medjuskl.Ul'
                    when d.vrsta_dok = (12) and d.tip_dok = 23 then
                         'STORNO INT.OTPR.'
                    when d.vrsta_dok in (21) then
                         'POCETNO STANJE'
                    when d.vrsta_dok in (90) then
                         'NIVEL.'
                    when d.vrsta_dok not in (80) then
                         SUBSTR(pp.naziv,1,19)
                    else
                         'NIVELACIJA'
               end naziv_partnera,
               CASE WHEN D.VRSTA_DOK = 3 AND D.TIP_DOK = 10 THEN
                         (select ' (OTPR: '||TRIM(za_broj_dok)||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 73 THEN
                         (select ' ('||TRIM(za_broj_dok)||'/'||za_godina||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 90 THEN
                         (select '(UZROK:'
                                   ||
                                   case when dp.vrsta_dok = 13 then
                                            'POVR.'
                                        WHEN DP.VRSTA_dok = 12 then
                                            'STOR.'
                                        ELSE
                                             ' '
                                   END
                                   ||dp.org_deo||'-'||dp.broj_dok1||'/'||SUBSTR(za_godina,3,2)||')'
                            from vezni_dok VDP, DOKUMENT DP

                           where VDP.vrsta_dok    = d.vrsta_dok
                             and VDP.broj_dok     = d.broj_dok
                             and VDP.godina       = d.godina
                             AND VDP.ZA_vrsta_dok = dp.vrsta_dok
                             and vdp.za_godina    = dp.godina
                             and vdp.za_broj_dok  = dp.broj_dok)
                    WHEN D.VRSTA_DOK = 13 THEN
                         (
                            select
                                   '(RN-OT:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)||')'
                              from vezni_dok VDX, DOKUMENT DX
                             where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                               AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                               AND VDX.ZA_GODINA    = DX.GODINA
                               AND VDX.vrsta_dok    = d.vrsta_dok
                               and VDX.broj_dok     = d.broj_dok
                               and VDX.godina       = d.godina
                              and za_vrsta_dok = '11'
                         )
                    ELSE

                    NULL
               END
               po_dokumentu,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok),0),2),0)
                   *
                   (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK in ('80','90') THEN
                               0
                         ELSE
                               1
                    END)
                            +
                    case when d.vrsta_dok in ('80') then
                              ROUND(st.kolicina*(NVL(st.cena1,0)-NVL(st.cena,0)),2)
                         WHEN d.vrsta_dok in ('90') then
                              case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                                        nvl(
                	                            (
                	                             	select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in ('13') then -1
                	                                	     	 when vd3.za_vrsta_dok in ('11','12','31','74','5') then 1
                	                               		    else 1
                	                               		    end
                	                               		   )
                     						 	 	from vezni_dok vd3
										     	 	where vd3.vrsta_dok = d.vrsta_dok
										              and vd3.godina    = d.godina
										              and vd3.broj_dok  = d.broj_dok
										              and vd3.za_vrsta_dok in('11','12','13','31','74','5')
										        )
											,-1)
                                  ELSE
                                     1
                             END
                             *
                             ROUND(st.kolicina*(
							                    (Case When st.valuta <> 'YUD' Then
							                         (
							                           Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
							                                           round(nvl(st.cena,0) *
							                                           Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
							                         	                              DECODE(D.PPARTNER, '206',2
							                        	                                               , '172',2
								                                                             , 4
								                                                            )
								                             )
							                           When D.Vrsta_Dok != '73' Then
							                                round(nvl(st.cena,0) *
							                                Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
							                           End
							                         )
							                     Else
							                         st.cena
							                     End
							                    )
                        -
                                      NVL(round(st.cena1*st.faktor,4),0)),2)
                        else
                           0
                   end
                   )                                                                                                                     ZADUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                    (Case When st.valuta <> 'YUD' Then
                         (
                           Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                   round(nvl(st.cena,0)*Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),DECODE(D.PPARTNER, '206',2, '172',2, 4))
                           When D.Vrsta_Dok != '73' Then
                                round(nvl(st.cena,0)*Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                           End
                         )
                     Else
                         st.cena
                     End
                    )
                   *st.rabat/100
                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1),0),2) ,0 ))                            RABAT,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                    (Case When st.valuta <> 'YUD' Then
                         (
                           Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                   round(nvl(st.cena,0)*Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),DECODE(D.PPARTNER, '206',2, '172',2, 4))
                           When D.Vrsta_Dok != '73' Then
                                round(nvl(st.cena,0)*Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                           End
                         )
                     Else
                         st.cena
                     End
                    )
                             * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                            ,0)
                   ,2),0)
                   )                                                                                                                     RAZDUZENJE
               ----------------------------------------------------------------------------------------------------------------------------------------------
          from dokument d,(SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
                                   CENA1,Z_TROSKOVI
                             FROM STAVKA_DOK

                            UNION ALL

                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
                               AND VDP.GODINA    = STP.GODINA
                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
                               AND VDP.ZA_VRSTA_DOK = '90'
                               AND STP.CENA<>round(STP.CENA1*stp.faktor,4)) ST
                         , proizvod p, poslovni_partner pp, organizacioni_deo orgd, vrsta_dok vd, nacin_fakt nf, org_deo_osn_podaci org_podaci
         where d.vrsta_dok = st.vrsta_dok
           and d.godina    = st.godina
           and d.broj_dok  = st.broj_dok
           and d.vrsta_dok = vd.vrsta
           and d.tip_dok   = nf.tip
           and st.proizvod = p.sifra
           and d.ppartner  = pp.sifra (+)
           and d.org_deo   = orgd.id
           and d.vrsta_dok not in ('2','9','10','61','62','63','64')
           and orgd.id     = org_podaci.org_deo
           and p.tip_proizvoda not in (8)
           and d.org_deo = &vZa_Magacin
           and d.datum_dok between  &DatumPocetnogStanja and &dDatumDo --to_date('31.12.'||to_char(dDatumOd,'yyyy'),'dd.mm.yyyy')
           AND D.STATUS > 0

        group by  d.org_deo,org_podaci.dodatni_tip,
                  d.vrsta_dok,vd.naziv ,
                  d.tip_dok, nf.naziv ,
                  d.broj_dok,d.broj_dok1,d.godina,
                  d.datum_dok,d.datum_unosa,
                  to_char(d.datum_dok,'dd.mm.yyyy') ,
                  d.org_deo||'-'||d.broj_dok1||'/'||d.godina ,
                  pp.naziv

        order by d.org_deo,d.datum_dok,d.datum_unosa)
)
"REM WORKSPACETAB5",Kepu,,395
	Select sum( ZADUZENJE ) zad
	     , sum( RAZDUZENJE ) razd
	     , sum( ZADUZENJE - RAZDUZENJE ) stanje
	from
	(
        select dodatni_tip,broj_dok,god_dok,vrsta_dok,
               TO_CHAR(datum_dok,'DD.MM.YY') DATUM,
               --------------------------------------------------------------------------------------------
               datum_dok,
               --------------------------------------------------------------------------------------------
               NVL(
               CASE WHEN zaduzenje<>0 and tip_dok in (10) and vrsta_dok not in ('4')  THEN
                       (
                        select 'KVPC:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)
                          from vezni_dok VDX, DOKUMENT DX
                         where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                           AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                           AND VDX.ZA_GODINA    = DX.GODINA
                           AND VDX.vrsta_dok = vr_dok
                           and VDX.broj_dok  = br_dok
                           and VDX.godina    = GOD_DOK
                          and za_vrsta_dok = '85'

                       )
                    WHEN zaduzenje <> 0 and vrsta_dok in ('73') THEN
                           'KVPC:'||dokument
                    WHEN vrsta_dok = '13' THEN
                       'POVR:'||dokument
                    WHEN vrsta_dok = '4' THEN
                       'STPR:'||dokument
                    ELSE
                       dokument
               END,'-') dokument,
               --------------------------------------------------------------------------------------------
               naziv_partnera||po_dokumentu naziv_partnera,
               --------------------------------------------------------------------------------------------
               case when NVL(zaduzenje,0) + NVL(rabat,0) <> 0 then
                         nvl(zaduzenje,0) + nvl(PDV_NA_ZADUZENJE,0)
                    else
                       0
               end zaduzenje,
               --------------------------------------------------------------------------------------------
               case when NVL(razduzenje,0) <> 0 then
                         nvl(razduzenje,0) + nvl(rabat,0) + nvl(PDV_RAZDUZENJE,0)
                    else
                       0
               end razduzenje
               --------------------------------------------------------------------------------------------
          from (

        select
               org_podaci.dodatni_tip,
               d.org_deo,
               d.vrsta_dok,vd.naziv vd_naziv,
               d.tip_dok, nf.naziv tip_naziv,
               d.broj_dok,d.broj_dok1,d.godina,
               D.GODINA GOD_DOK,
               D.BROJ_DOK BR_DOK,
               D.VRSTA_DOK VR_DOK,
               d.datum_dok,d.datum_unosa,
               to_char(d.datum_dok,'dd.mm.yyyy') datum,
               D.ORG_DEO||'-'||d.broj_dok1||'/'||substr(d.godina,3,4) dokument,
               case when d.vrsta_dok = (11) and d.tip_dok in (23,238) then
                         'Int.Otprema'
                    when d.vrsta_dok = (3) and d.tip_dok in (115) then
                         'Int.Prijem'
                    when d.vrsta_dok in (70) then
                         'Medjuskl.Izl'
                    when d.vrsta_dok in (71) then
                         'Medjuskl.Ul'
                    when d.vrsta_dok = (12) and d.tip_dok = 23 then
                         'STORNO INT.OTPR.'
                    when d.vrsta_dok in (21) then
                         'POCETNO STANJE'
                    when d.vrsta_dok in ('90') then
                         'NIVEL.'
                    when d.vrsta_dok not in ('80') then
                         SUBSTR(pp.naziv,1,19)
                    else
                         'NIVELACIJA'
               end naziv_partnera,
               CASE WHEN D.VRSTA_DOK = 3 AND D.TIP_DOK = 10 THEN
                         (select ' (OTPR: '||TRIM(za_broj_dok)||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = 73 THEN
                         (select ' ('||TRIM(za_broj_dok)||'/'||za_godina||')' from vezni_dok where vrsta_dok = d.vrsta_dok and broj_dok = d.broj_dok and godina = d.godina and za_vrsta_dok = '24')
                    WHEN D.VRSTA_DOK = '90' THEN
                         (select '(UZROK:'
                                   ||
                                   case when dp.vrsta_dok = 13 then
                                            'POVR.'
                                        WHEN DP.VRSTA_dok = 12 then
                                            'STOR.'
                                        ELSE
                                             ' '
                                   END
                                   ||dp.org_deo||'-'||dp.broj_dok1||'/'||SUBSTR(za_godina,3,2)||')'
                            from vezni_dok VDP, DOKUMENT DP

                           where VDP.vrsta_dok    = d.vrsta_dok
                             and VDP.broj_dok     = d.broj_dok
                             and VDP.godina       = d.godina
                             AND VDP.ZA_vrsta_dok = dp.vrsta_dok
                             and vdp.za_godina    = dp.godina
                             and vdp.za_broj_dok  = dp.broj_dok)
                    WHEN D.VRSTA_DOK = 13 THEN
                         (
                            select
                                   '(RN-OT:'||DX.ORG_DEO||'-'||DX.BROJ_DOK1||'/'||SUBSTR(DX.GODINA,3,2)||')'
                              from vezni_dok VDX, DOKUMENT DX
                             where VDX.ZA_VRSTA_DOK = DX.VRSTA_DOK
                               AND VDX.ZA_BROJ_DOK  = DX.BROJ_DOK
                               AND VDX.ZA_GODINA    = DX.GODINA
                               AND VDX.vrsta_dok    = d.vrsta_dok
                               and VDX.broj_dok     = d.broj_dok
                               and VDX.godina       = d.godina
                              and za_vrsta_dok = '11'
                         )
                    ELSE

                    NULL
               END
               po_dokumentu,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(
	                        round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.FAKTOR*ST.K_ROBE*st.cena1 *
	                                  PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'D',d.datum_dok)
	                                 ,0)
	                              ,
	                              DECODE(D.PPARTNER, '206',2
	                                               , '172',2
	                                               , 4
	                                    )

	                             )
                       ,0)*

                   (case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                               0
                         ELSE
                               1
                    END)
                            +
                    case when d.vrsta_dok in ('80') then
                              ROUND(st.kolicina*(NVL(st.cena1,0)-NVL(st.cena,0)),2)
                         WHEN d.vrsta_dok in ('90') then
                              case when UPPER(ORG_PODACI.dodatni_tip) like 'VP%' AND D.VRSTA_DOK='90' THEN
                                        nvl(
                	                            (
                	                             	select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in (13) then -1
                	                                	     	 when vd3.za_vrsta_dok in (11,12,31,74) then 1
                	                               		    else 1
                	                               		    end
                	                               		   )
                     						 	 	from vezni_dok vd3
										     	 	where vd3.vrsta_dok = d.vrsta_dok
										              and vd3.godina    = d.godina
										              and vd3.broj_dok  = d.broj_dok
										              and vd3.za_vrsta_dok in(11,12,13,31,74)
										        )
											,-1)

                                  ELSE
                                     1
                             END
                             *
                             ROUND(st.kolicina*(
                    (Case When st.valuta <> 'YUD' Then
                         (
                           Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                               (
                                 Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                           round(nvl(st.cena,0) *
                                           Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                      Else
                                           round(nvl(st.cena,0) *
                                           Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                           Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                      End
                               )
                           When D.Vrsta_Dok != '73' Then
                                round(nvl(st.cena,0) *
                                Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                           End
                         )
                     Else
                         st.cena
                     End
                    )
                        -
                                      NVL(st.cena1*st.faktor,0)),2)
                        else
                           0
                   end
                   )                                                                                                                     ZADUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                    (Case When st.valuta <> 'YUD' Then
                         (
                           Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                               (
                                 Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                           round(nvl(st.cena,0) *
                                           Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                      Else
                                           round(nvl(st.cena,0) *
                                           Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                           Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                      End
                               )
                           When D.Vrsta_Dok != '73' Then
                                round(nvl(st.cena,0) *
                                Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                           End
                         )
                     Else
                         st.cena
                     End
                    )
                   *st.rabat/100
                   *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1),0),2) ,0 ))                            RABAT,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                    (Case When st.valuta <> 'YUD' Then
                         (
                           Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                               (
                                 Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                           round(nvl(st.cena,0) *
                                           Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                      Else
                                           round(nvl(st.cena,0) *
                                           Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                           Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                      End
                               )
                           When D.Vrsta_Dok != '73' Then
                                round(nvl(st.cena,0) *
                                Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                           End
                         )
                     Else
                         st.cena
                     End
                    )
                             * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                            ,0)
                   ,2),0)
                   )                                                                                                                     RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               sum( --ROUND(
                    CASE WHEN &nPrikaziPDV = 0 Then
                              0
                    ELSE
                        (
                         NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                                       (Case When st.valuta <> 'YUD' Then
                                            (Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                                  (
                                                    Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                                              round(nvl(st.cena,0) *
                                                              Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                                    Else
                                                              round(nvl(st.cena,0) *
                                                              Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                                              Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                                    End
                                                  )
                                              When D.Vrsta_Dok != '73' Then
                                                   round(nvl(st.cena,0) *
                                                   Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                              End
                                            )
                                        Else
                                            st.cena
                                        End
                                       )
                                       * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)
                                      ,0)
                                  ,2)
                             ,0)
                             --- RAZDUZENJE KRAJ
                       +
                         NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                                       (Case When st.valuta <> 'YUD' Then
                                            (Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                                  (
                                                    Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                                              round(nvl(st.cena,0) *
                                                              Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                                    Else
                                                              round(nvl(st.cena,0) *
                                                              Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                                              Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                                    End
                                                  )
                                              When D.Vrsta_Dok != '73' Then
                                                   round(nvl(st.cena,0) *
                                                   Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                              End
                                            )
                                        Else
                                            st.cena
                                        End
                                       )
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                      ,0)
                                   ,2)
                             ,0 )
                             --- RABAT KRAJ
                         )
                       *
                                 -- posebno obradjeno kad nije unipasan pdv na stavkama
                                 -- po novom treba prikazti pdv za svaku vrstu dokumenta
                                 nvl(st.porez,PPorez.ProcenatPoreza( d.Poslovnica,St.Proizvod, D.Datum_Dok, '3' )) / 100
                    END
                    --,2)
                   )                                                                                                                     PDV_RAZDUZENJE,
               ----------------------------------------------------------------------------------------------------------------------------------------------
               CASE WHEN &nPrikaziPDV = 1 then
                         0
 -- prikaz bez pdv
               ELSE
                      sum(NVL(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*DECODE(ST.VRSTA_DOK,'90',0,ST.K_ROBE)*
                                        (Case When st.valuta <> 'YUD' Then
                                            (Case When (upper(VratiTipIzvoza(d.org_deo)) = 'DA' or d.org_deo = 200) And D.Vrsta_Dok = 73 Then
                                                  (Case When Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner) = -2 Then
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                                   Else
                                                             round(nvl(st.cena,0) *
                                                             Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),
                                                             Pmapiranje.BrojDecimalaNaseFirme(PMapiranje.VLASNIK_CONN_STR,D.vrsta_dok,D.PPartner))
                                                   End
                                                  )
                                                  When D.Vrsta_Dok != '73' Then
                                                       round(nvl(st.cena,0) *
                                                       Pkurs.KursNaDan(valuta, d.Datum_dok, 'S'),4)
                                             End
                                            )
                                         Else
                                             st.cena
                                         End
                                        )
                                      * st.rabat/100
                                      * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,st.K_ROBE,'P',d.datum_dok)*(-1)
                                      ,0)
                                   ,2)
                             ,0 )
                         )
               END                                                                                                                        PDV_NA_ZADUZENJE
               ----------------------------------------------------------------------------------------------------------------------------------------------
          from dokument d,(SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
                                   CENA1,Z_TROSKOVI
                             FROM STAVKA_DOK

                            UNION ALL

                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
                               AND VDP.GODINA    = STP.GODINA
                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
                               AND VDP.ZA_VRSTA_DOK = '90'
                               AND STP.CENA<>round(STP.CENA1*stp.faktor,4)) ST
                         , proizvod p, poslovni_partner pp, organizacioni_deo orgd, vrsta_dok vd, nacin_fakt nf, org_deo_osn_podaci org_podaci
         where d.vrsta_dok = st.vrsta_dok
           and d.godina    = st.godina
           and d.broj_dok  = st.broj_dok
           and d.vrsta_dok = vd.vrsta
           and d.tip_dok   = nf.tip
           and st.proizvod = p.sifra
           and d.ppartner  = pp.sifra (+)
           and d.org_deo   = orgd.id
           and d.vrsta_dok not in (2,9,10,61,62)
           and orgd.id     = org_podaci.org_deo
           and p.tip_proizvoda not in (8)
           and d.org_deo   = &vZa_Magacin
           and d.datum_dok between  &DatumPocetnogStanja and &dDatumDo --to_date('31.12.'||to_char(dDatumOd,'yyyy'),'dd.mm.yyyy')
           AND D.STATUS > 0

        group by  d.org_deo,org_podaci.dodatni_tip,
                  d.vrsta_dok,vd.naziv ,
                  d.tip_dok, nf.naziv ,
                  d.broj_dok,d.broj_dok1,d.godina,
                  d.datum_dok,d.datum_unosa,
                  to_char(d.datum_dok,'dd.mm.yyyy') ,
                  d.org_deo||'-'||d.broj_dok1||'/'||d.godina ,
                  pp.naziv
        order by d.org_deo,d.datum_dok,d.datum_unosa)
	)
"REM WORKSPACETAB6","stanje zal",,63
	select sum(STANJE) st
	     , sum(VREDNOST) vred
	     , sum(U_KONTROLI) kont
	from
	(
	         Select Stavka_dok.Proizvod, Proizvod.posebna_grupa,
	                round(Sum(NVL(decode(dokument.tip_dok,14,Kolicina,realizovano)*Faktor

	                                * case when dokument.vrsta_dok = '90' then
	                                         0
	                                       else
	                                         K_ROBE
	                                  end

	                                ,0)),5) STANJE,

	                round(Sum(NVL(decode(dokument.tip_dok,14,Kolicina,realizovano)*Faktor*
	                   (CASE WHEN DOKUMENT.VRSTA_DOK = '80' THEN
	                         (STAVKA_DOK.CENA1-STAVKA_DOK.CENA)
--	                        WHEN dokument.vrsta_dok  ='90' then
--	                             ROUND((NVL(stavka_dok.cena,0)-NVL(stavka_dok.cena1,0)),2)
	                    ELSE K_ROBE*(
	                                     CASE WHEN DOKUMENT.VRSTA_DOK = 11 AND UPPER(ORGD.DODATNI_TIP) = 'VP2' THEN
	                                             STAVKA_DOK.CENA1
	                                          ELSE
	                                             STAVKA_DOK.CENA1
	                                     END
	                                 )
	                END),0)),2) VREDNOST

	               , (select sum(kolicina*faktor)
	                   from dokument dx, stavka_dok stx
	                  where dx.vrsta_dok = stx.vrsta_dok and dx.broj_dok = stx.broj_dok and dx.godina = stx.godina
	                    and dx.vrsta_dok = 3
	                    and dx.tip_dok   = 10
	                    and dx.status in ('-8','-9') and dx.godina > 2008
	                    and stx.proizvod = stavka_dok.proizvod)
	                  u_kontroli

	               From Dokument,
	                    (SELECT  BROJ_DOK,
	                             VRSTA_DOK,
	                             GODINA,
	                             STAVKA,PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
	                       FROM STAVKA_DOK
	                    ) Stavka_Dok,
	                    Proizvod,
	                    ORG_DEO_OSN_PODACI ORGD

	         Where Dokument.Vrsta_Dok = Stavka_Dok.Vrsta_Dok And
	               Dokument.Broj_Dok = Stavka_Dok.Broj_Dok And
	               Dokument.Godina = Stavka_Dok.Godina And
	               DOKUMENT.ORG_DEO = ORGD.ORG_DEO (+) AND
	               Dokument.Status > 0 And
	               dokument.datum_dok between  &DatumPocetnogStanja and &dDatumDo and

	               (Stavka_Dok.K_Robe != 0 OR DOKUMENT.VRSTA_DOK = '80') And
	               Dokument.Org_Deo = &vZa_Magacin And Proizvod.sifra=Stavka_dok.proizvod
	           and dokument.vrsta_dok not in (2,9,10,61,62)
	           and proizvod.tip_proizvoda not in (8)
	         Group By Stavka_dok.Proizvod,Proizvod.tip_proizvoda,Proizvod.posebna_grupa,Proizvod.grupa_proizvoda,Proizvod.naziv
	         Order By Proizvod.posebna_grupa,Stavka_dok.proizvod
)
"REM WORKSPACETAB7",Dok_st,,69
--select sum(razl_rabat), sum(razl)
--     , sum(razl_rabat) + sum(razl)
--
--select *
--from
--(
select d.datum_dok, d.vrsta_dok VR, d.org_Deo mag, d.broj_dok1 BRD1, d.broj_dok BRD --, d.datum_unosa
     , d.tip_dok tipd
     , sd.proizvod PRO
     , sd.cena, SD.KOLICINA kol, sd.k_robe kr, SD.REALIZOVANO rlz, sd.faktor fak, sd.cena1, round(Sd.CENA1*sd.faktor,4) cc1, sd.rabat
     , SD.k_robe K_R
     , vd.za_vrsta_dok ZAV, vd.za_broj_dok ZAB, vd.za_godina ZAG
     , round(sd.cena * kolicina * sd.k_robe * sd.faktor,2) VRED
     , (round(Sd.CENA1*sd.faktor,4) - sd.cena) * kolicina * SD.k_robe razl
     , case when round(Sd.CENA1*sd.faktor,4) - sd.cena <> 0 Then 1 else 0 end ima_raz
     , round(Sd.CENA1*sd.faktor,4)-cena razl_1
     , PDokument.ZokiUlazIzlaz(d.vrsta_Dok,d.tip_dok,sd.k_robe,'D',d.datum_dok) ui_d
     , PDokument.ZokiUlazIzlaz(d.vrsta_Dok,d.tip_dok,sd.k_robe,'P',d.datum_dok) ui_p

from dokument d, stavka_dok sd, PROIZVOD P , GRUPA_PR  GPR, VRSTA_DOK VR
   , (select vd.* from vezni_dok vd, dokument d
      where d.godina = vd.godina and d.vrsta_dok = vd.vrsta_dok and d.broj_dok = vd.broj_dok
        and d.broj_dok >'0'
        and d.vrsta_dok not in ('2','9','10','61','62')
        and '2011' = d.godina
--        and d.org_deo = 105
--        and d.datum_dok=to_date('30.06.2011','dd.mm.yyyy')
        and d.status>0
        and za_vrsta_dok='90'
     ) vd
Where
  -- veza tabela
      d.godina = sd.godina and d.vrsta_dok = sd.vrsta_dok and d.broj_dok = sd.broj_dok
  AND SD.PROIZVOD = P.SIFRA AND P.GRUPA_PROIZVODA=  GPR.ID
  -----------------------------
  -- ostali uslovi
  and '2011' = d.godina
--  and d.org_deo = 105
  and d.vrsta_dok not in (2,9,10,61,62)
--  and d.vrsta_Dok='13'
--  and d.datum_dok=to_date('30.06.2011','dd.mm.yyyy')
--  and d.datum_dok<=to_date('29.06.2011','dd.mm.yyyy')
  and org_Deo  between 105 and 105
  and org_Deo not between 123 and 128
  and d.status>0
  and p.tip_proizvoda=9
--  AND SD.PROIZVOD in (
--                         '4510'
--                       ,
--                         '4539'
--                     )
--in ('4510'
--                      --,'4539'
--                     )
  and d.godina = vd.godina (+) and d.vrsta_dok = vd.vrsta_dok(+) and d.broj_dok = vd.broj_dok(+)
  AND VR.VRSTA=D.VRSTA_DOK
--  AND VR.K_OCEK<>SD.K_OCEK
--  AND VR.K_REZ<>SD.K_REZ
--  AND VR.K_ROBE<>SD.K_ROBE
--  and sd.cena<> round(Sd.CENA1*sd.faktor,4)

--  and d.vrsta_dok not in ('5')
--  and d.vrsta_dok in ('5')
--AND KOLICINA<>REALIZOVANO
--and round(Sd.CENA1*sd.faktor,4) - sd.cena <> 0
order by SD.PROIZVOD, d.datum_dok, d.datum_unosa
--)
--where za_vrsta_dok is null
--order by datum_dok, datum_unosa
"REM WORKSPACETAB8",Dok_St_razlike,,64
select DATUM_DOK,VR,BRD1,BRD
--     ,DATUM_UNOSA
     , PRO,CENA,KOLICINA,REALIZOVANO,FAKTOR,CENA1,CENA_OD_C1,RABAT,K_R,ZAV,ZAB,ZAG,VRED,RAZL,IMA_RAZ,raz_1
from
(
select d.datum_dok, d.vrsta_dok VR, d.broj_dok1 BRD1, d.broj_dok BRD, d.datum_unosa
     , sd.proizvod PRO
     , sd.cena, SD.KOLICINA, SD.REALIZOVANO, sd.faktor, sd.cena1, round(Sd.CENA1*sd.faktor,4) cena_od_c1, sd.rabat
     , SD.k_robe K_R
     , vd.za_vrsta_dok ZAV, vd.za_broj_dok ZAB, vd.za_godina ZAG
     , round(sd.cena * kolicina * sd.k_robe * sd.faktor,2) VRED
     , round((round(Sd.CENA1*sd.faktor,4) - sd.cena) * kolicina * SD.k_robe,2) razl
     , case when round(Sd.CENA1*sd.faktor,4) - sd.cena <> 0 Then 1 else 0 end ima_raz
     , round(Sd.CENA1*sd.faktor,4)-cena raz_1

from dokument d, stavka_dok sd, PROIZVOD P , GRUPA_PR  GPR, VRSTA_DOK VR
   , (select vd.* from vezni_dok vd, dokument d
      where d.godina = vd.godina and d.vrsta_dok = vd.vrsta_dok and d.broj_dok = vd.broj_dok
        and d.broj_dok >'0'
        and d.vrsta_dok not in ('2','9','10','61','62')
        and '2011' = d.godina
        and d.org_deo = 105
--        and d.datum_dok=to_date('30.06.2011','dd.mm.yyyy')
        and d.status>0
        and za_vrsta_dok='90'
     ) vd
Where
  -- veza tabela
      d.godina = sd.godina and d.vrsta_dok = sd.vrsta_dok and d.broj_dok = sd.broj_dok
  AND SD.PROIZVOD = P.SIFRA AND P.GRUPA_PROIZVODA=  GPR.ID
  -----------------------------
  -- ostali uslovi
  and '2011' = d.godina
  and d.org_deo = 105
  and d.vrsta_dok not in (2,9,10,61,62)
--  and d.vrsta_dok  in (5)
--  and d.datum_dok=to_date('30.06.2011','dd.mm.yyyy')
--  and d.datum_dok<=to_date('29.06.2011','dd.mm.yyyy')
  and d.status>0
  and p.tip_proizvoda=9
--  AND SD.PROIZVOD in (
--                         '4510'
--                       ,
--                         '4539'
--                     )
----in ('4510'
----                      --,'4539'
----                     )
  and d.godina = vd.godina (+) and d.vrsta_dok = vd.vrsta_dok(+) and d.broj_dok = vd.broj_dok(+)
  AND VR.VRSTA=D.VRSTA_DOK
--  AND VR.K_OCEK<>SD.K_OCEK
--  AND VR.K_REZ<>SD.K_REZ
--  AND VR.K_ROBE<>SD.K_ROBE
--  and sd.cena<> round(Sd.CENA1*sd.faktor,4)

--  and d.vrsta_dok not in ('5')
--  and d.vrsta_dok in ('5')
--AND KOLICINA<>REALIZOVANO
and (round(Sd.CENA1*sd.faktor,4) - sd.cena) * sd.k_robe <> 0
--and sd.faktor<>1
order by SD.PROIZVOD, d.datum_dok, d.datum_unosa
)
where zav is null
order by pro, datum_dok, datum_unosa
"REM WORKSPACETAB9","provera kepu",,155
--select
--       sum(ZADUZENJE) ZADUZENJE,
--       sum(RAZDUZENJE) RAZDUZENJE,
--       sum(ZADUZENJE) - sum(RAZDUZENJE) stanje
--
--from
--(
--	select
--	       178220713.16 ZADUZENJE
--	     , 174746158.86 RAZDUZENJE
--	From dual
--	union
	select
	       sum(ZADUZENJE) ZADUZENJE,
	       sum(RAZDUZENJE) RAZDUZENJE,
	       sum(ZADUZENJE) - sum(RAZDUZENJE) stanje

	from
	(
		SELECT DATUM_DOK
		, DATUM_UNOSA
		, VR_DOK, BROJ_DOK1
		--, SUM(ROUND(CENA*KOLICINA*RABAT/100,2)) RAB_IZNOS
		, SUM(ROUND(CENA*KOLICINA*(100-RABAT)/100,2)) VRED_KUP
		, SUM(ROUND(CENA*KOLICINA*(100-RABAT)/100*(100+POREZ)/100,2)) VRED_KUP_POREZ
		, SUM(ZADUZENJE)  ZAD
		, SUM(KEPU_RAB) KEPU_RAB
		, SUM(RAZDUZENJE)  RAZD

		, case when SUM(zaduzenje) + NVL(SUM(rabat),0) <> 0 then
		            SUM(ZADUZENJE) + SUM(KEPU_RAB)
		  END ZADUZENJE
		, CASE WHEN SUM(RAZDUZENJE) <> 0 THEN
		            SUM(RAZDUZENJE) + SUM(KEPU_RAB)
		  END RAZDUZENJE


		FROM
		(
			select d.datum_dok, D.datum_unosa, D.GODINA GOD_DOK,d.vrsta_dok VR_DOK, d.broj_dok1, d.broj_dok BR_DOK, D.ORG_DEO, TIP_DOK
			     , sd.proizvod
			     , sd.cena, SD.KOLICINA, sd.faktor, sd.cena1, round(Sd.CENA1*sd.faktor,4) cena_od_c1, sd.rabat, SD.POREZ
			     , vd.za_vrsta_dok, vd.za_broj_dok, vd.za_godina

			     , round(sd.cena * kolicina * sd.faktor,2) razl_rabat
			     , (round(Sd.CENA1*sd.faktor,4) - sd.cena) * kolicina razl

		         , NVL(
		               round(nvl(sign(SD.K_ROBE)*SD.KOLICINA*SD.FAKTOR*SD.K_ROBE*SD.cena1 *
		                         PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,SD.K_ROBE,'D',d.datum_dok)
		                        ,0),DECODE(D.PPARTNER, '206',2, '172',2, 4)
		                    ),0)
		                    *
		                    (case when D.VRSTA_DOK='90' THEN 0 ELSE 1 END)
		                            +
		                     case when d.vrsta_dok in (80) then
		                               ROUND(SD.kolicina*(NVL(SD.cena1,0)-NVL(SD.cena,0)),2)
		                          WHEN d.vrsta_dok in (90) then
		                                        nvl(
		                	                         (
		                	                          select (case when vd3.za_vrsta_dok is null or vd3.za_vrsta_dok in (13) then -1
		                	                              	       when vd3.za_vrsta_dok in (11,12,13,31,74) then 1
		                	                               	  else 1
		                	                               	  end
		               	                               		   )
		                   						 	 	from vezni_dok vd3
											     	 	where vd3.vrsta_dok = d.vrsta_dok
											              and vd3.godina    = d.godina
											              and vd3.broj_dok  = d.broj_dok
											              and vd3.za_vrsta_dok in(11,12,13,31,74)
												        )
													,-1)
		                             *
		                             ROUND(SD.kolicina*(sd.cena-NVL(SD.cena1*SD.faktor,0)),2)
		                     else
		                           0
		                     end
		--                   )
		                   ZADUZENJE

		,               NVL(round(nvl(sign(SD.K_ROBE)*SD.KOLICINA*DECODE(SD.VRSTA_DOK,'90',0,SD.K_ROBE)*SD.cena
		                    *SD.rabat/100
		                    *PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,SD.K_ROBE,'P',d.datum_dok)*(-1),0),2) ,0 )  KEPU_RAB


		,               NVL(round(nvl(sign(SD.K_ROBE)*SD.KOLICINA*DECODE(SD.VRSTA_DOK,'90',0,SD.K_ROBE)*SD.CENA--1*SD.FAKTOR
		                             * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,SD.K_ROBE,'P',d.datum_dok)
		                            ,0)
		                   ,2),0)
		                                                                                                                                        RAZDUZENJE

		--	from dokument d, stavka_dok sd, PROIZVOD P , GRUPA_PR  GPR
			from dokument d, PROIZVOD P , GRUPA_PR  GPR
		       , (SELECT  BROJ_DOK,VRSTA_DOK,GODINA,STAVKA,
		                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,VALUTA,
		                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,
		                                   RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
		                                   CENA1,Z_TROSKOVI
		                             FROM STAVKA_DOK

		                            UNION ALL

		                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
		                                   PROIZVOD,LOT_SERIJA,ROK,KOLICINA,JED_MERE,CENA,
		                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,
		                                   RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
		                              FROM STAVKA_DOK STP, VEZNI_DOK VDP
		                             WHERE VDP.VRSTA_DOK = STP.VRSTA_DOK
		                               AND VDP.GODINA    = STP.GODINA
		                               AND VDP.BROJ_DOK  = STP.BROJ_DOK
		                               AND VDP.ZA_VRSTA_DOK = '90'
		                               AND STP.CENA<>ROUND(STP.CENA1*STP.FAKTOR,4)) SD
		       , (select vd.* from vezni_dok vd, dokument d
			      where d.godina = vd.godina and d.vrsta_dok = vd.vrsta_dok and d.broj_dok = vd.broj_dok
			        and d.broj_dok >'0'
			        and d.vrsta_dok not in ('2','9','10','61','62')
			        and '2011' = d.godina
			        and d.org_deo = 105
		--	        and d.datum_dok<=to_date('30.06.2011','dd.mm.yyyy')
			        and d.status>0
			        and za_vrsta_dok='90'
			     ) vd
			Where
			  -- veza tabela
			      d.godina = sd.godina and d.vrsta_dok = sd.vrsta_dok and d.broj_dok = sd.broj_dok
			  AND SD.PROIZVOD = P.SIFRA AND P.GRUPA_PROIZVODA=  GPR.ID
			  -----------------------------
			  -- ostali uslovi
			  and '2011' = d.godina
			  and d.org_deo = 105
			  and d.vrsta_dok not in (2,9,10,61,62)
			  and d.datum_dok<=to_date('30.06.2011','dd.mm.yyyy')
			  and d.status>0
			  and p.tip_proizvoda=9
			  and d.godina = vd.godina (+) and d.vrsta_dok = vd.vrsta_dok(+) and d.broj_dok = vd.broj_dok(+)
--and proizvod in(4510)
--				and proizvod not in (
-- '4510'
----,
---- '4539'
--
----				'4421','4422','4430','4431','4432','4433','4434','4441','4442','4449','4450','4452','4454','4455','4456'
----				                 '4457','4458','4459','4460','4461','4462','4463','4464','4465','4466','4467','4468','4469','4471','4472',
----				                 '4473','4474','4476','4483','4484','4485','4487','4488','4489','4490','4491','4492','4493','4494','4495',
----				                 '4496','4497','4499','4500','4501','4503','4506','4507','4508','4509','4510','4511','4512','4513','4514'
----				                 ,
----				                 '4515','4516','4518','4519','4520','4521','4522','4539','6021','6022','6978','6979','10778'
--)
--and d.vrsta_dok not in(80)
		)
		GROUP BY DATUM_DOK
		,org_deo, VR_DOK, BROJ_DOK1, datum_unosa
		order by org_deo,datum_dok, datum_unosa
	)
--)
"REM WORKSPACETAB10",Niv_dok,,24
SELECT d.status, d.datum_dok, d.datum_unosa, d.broj_dok, D.org_deo, d.broj_dok1
     , vd.ZA_BROJ_DOK, vd.ZA_VRSTA_DOK, vd.ZA_GODINA
     , d1.status, d1.datum_dok, d1.datum_unosa, d1.broj_dok, D1.org_deo, d1.broj_dok1
     , (select sum(sd1.cena-round(Sd1.CENA1*sd1.faktor,4)*kolicina)
        from stavka_dok sd1
        where d1.godina = sd1.godina and d1.vrsta_dok = sd1.vrsta_dok and d1.broj_dok = sd1.broj_dok
          and sd1.cena<> round(Sd1.CENA1*sd1.faktor,4)
--          AND SD1.proizvod NOT in ('4510','4539')
       ) uk_sta
FROM
     dokument d
   , VEZNI_DOK vd
   , dokument d1
--   , stavka_dok sd1
WHERE d.godina = 2011
  and d.org_deo = 105
  and d.vrsta_Dok=90
  and d.godina = vd.godina and d.vrsta_dok = vd.vrsta_dok and d.broj_dok = vd.broj_dok
  and d1.godina = vd.za_godina and d1.vrsta_dok = vd.za_vrsta_dok and d1.broj_dok = vd.za_broj_dok
--  and d1.godina = sd1.godina and d1.vrsta_dok = sd1.vrsta_dok and d1.broj_dok = sd1.broj_dok
--and d.datum_dok <> d1.datum_dok
--and d.org_deo <> d1.org_deo
Order by d.datum_dok, d.datum_unosa

"REM WORKSPACETAB11",Query28,,31
SELECT
d.status, d.datum_dok, d.datum_unosa, d.broj_dok, D.org_deo, d.broj_dok1
--,
--count(*) uk
--     , vd.ZA_BROJ_DOK, vd.ZA_VRSTA_DOK, vd.ZA_GODINA
--     , d1.status, d1.datum_dok, d1.datum_unosa, d1.broj_dok, D1.org_deo, d1.broj_dok1
--     , (select sum(sd1.cena-round(Sd1.CENA1*sd1.faktor,4)*kolicina)
--        from stavka_dok sd1
--        where d1.godina = sd1.godina and d1.vrsta_dok = sd1.vrsta_dok and d1.broj_dok = sd1.broj_dok
--          and sd1.cena<> round(Sd1.CENA1*sd1.faktor,4)
----          AND SD1.proizvod NOT in ('4510','4539')
--       ) uk_sta
FROM
     dokument d
   , VEZNI_DOK vd
--   , dokument d1
--   , stavka_dok sd1
WHERE d.godina = 2011
  and d.org_deo = 105
  and d.vrsta_Dok=90
  and d.godina = vd.godina and d.vrsta_dok = vd.vrsta_dok and d.broj_dok = vd.broj_dok
--  and d1.godina = vd.za_godina and d1.vrsta_dok = vd.za_vrsta_dok and d1.broj_dok = vd.za_broj_dok
--  and d1.godina = sd1.godina and d1.vrsta_dok = sd1.vrsta_dok and d1.broj_dok = sd1.broj_dok
--and d.datum_dok <> d1.datum_dok
--and d.org_deo <> d1.org_deo
--Group by
----d.status, d.datum_dok, d.datum_unosa, d.broj_dok, D.org_deo, d.broj_dok1
----     ,
--     vd.ZA_BROJ_DOK, vd.ZA_VRSTA_DOK, vd.ZA_GODINA
--having count(*) > 1
Order by d.datum_dok, d.datum_unosa
"REM WORKSPACETAB12",Query19,,2
Select PDokument.ZokiUlazIzlaz('5',40,'-1','D',sysdate)
from dual
"REM WORKSPACETAB13","Iznosi na stavkama",,75
select

       DATUM_DOK,VRSTA_DOK vrd, TIP_DOK, tip_naziv, STATUS
     , ORG_DEO mag,BROJ_DOK1 brd1, BROJ_DOK brd, GODINA god
     , PPARTNER,PRT_NAZIV
     , VRED
     , RABAT_IZN
--     , PROIZVOD,PRO_NAZIV,JED_MERE,VAL,cena,KOL,RABAT, porez
     , VRED
     , RABAT_IZN,KASA
     , akciza_iznos
     , (Vred-RABAT_IZN)*(1- nvl(Kasa,0)/100) + akciza_iznos PDV_OSN
     , PDV_IZNOS,TAKSA_IZNOS
     , (Vred-RABAT_IZN)*(1- nvl(Kasa,0)/100)+ akciza_iznos + PDV_IZNOS + taksa_iznos za_kupca
from
(
	Select
	       d.vrsta_dok,
	       d.status,
	       d.broj_dok, D.ORG_DEO , D.BROJ_DOK1,
	       d.Godina,d.datum_dok,d.datum_unosa,
--	       pp.Teren,pp.Naziv
	       d.PPartner, pp.naziv prt_naziv,
	       d.tip_dok, nf.naziv tip_naziv,
--	       p.grupa_proizvoda,p.posebna_grupa,
	       sd.proizvod,p.naziv pro_naziv,
	       p.Jed_mere,
	       nvl(sd.Valuta,'YUD') val,
	       sd.cena,
	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina,0),2)) 															kol,
	       sd.rabat,
	       sd.Porez,
	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina*sd.Cena,0),2)) 													vred,

	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina*sd.Cena*sd.Rabat/100,0),2)) 									rabat_izn,
	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina*sd.Cena*(1-sd.Rabat/100)*
	           Decode( d.Tip_Kase, 'A', d.Kasa, 0 )/100,0),2)) 														kasa,
	       Sum(NVL((-1)*sd.K_Robe*sign(sd.Kolicina)*sd.Akciza,0))													akciza_iznos,
	       Sum(Round(NVL((-1)*sd.K_Robe*(sd.Kolicina*sd.Cena*(1-sd.Rabat/100-
	           Decode(d.Tip_Kase,'A',d.Kasa,0)/100)+sign(sd.Kolicina)*NVL( sd.Akciza, 0))*sd.Porez/100,0),2)) 		pdv_iznos,
	       Sum(NVL((-1)*sd.K_Robe*sd.Taksa,0))																	    taksa_iznos
	From Dokument d, Stavka_Dok sd, Poslovni_Partner pp, Proizvod p, nacin_fakt nf
	Where d.Status > 0 And
--	      d.Vrsta_Dok In ( '11', '12', '13', '31', '74', '80' ) And
          (k_robe<>0 or d.vrsta_Dok = '80') And
	      d.Org_deo not in ( select magacin from Partner_magacin_flag) and
          D.DATUM_DOK between to_date('29.06.2011','dd.mm.yyyy') and to_date('30.06.2011','dd.mm.yyyy') and
	      sd.Vrsta_Dok = d.Vrsta_Dok And
	      sd.Broj_Dok = d.Broj_Dok And
	      sd.Godina = d.Godina And
	      pp.Sifra = d.Ppartner and
	      p.Sifra = sd.Proizvod and
	      nf.tip=d.tip_dok
           and d.vrsta_dok not in (2,9,10,61,62)
           and p.tip_proizvoda not in (8)
--	      and (d.ppartner in(  '1583', '6151', '4997', '282', '1981', '519', '8672', '5987') ) --or d.pp_isporuke=
	      and d.godina = 2011
          and d.org_deo = 105

	--      and d.vrsta_dok=4
	Group by
	         d.vrsta_dok,
	         d.status,
--	         nvl(sd.Valuta,'YUD'),
--	         sd.cena,
	         d.broj_dok, D.ORG_DEO , D.BROJ_DOK1,
	         d.Godina,d.datum_dok,d.datum_unosa,
--	         pp.Teren,
             d.PPartner, pp.Naziv,
	         d.tip_dok,nf.naziv
--	         ,p.grupa_proizvoda, p.posebna_grupa,
--	         sd.proizvod,p.naziv,
--	         p.Jed_mere, sd.rabat, sd.Porez
)
order by datum_dok, datum_unosa --, status ,D.ORG_DEO || D.BROJ_DOK1 , to_number(D.PPARTNER)
"REM WORKSPACETAB14","Iznosi na stavkama KAO KEPU",,151
select

       DATUM_DOK,VRSTA_DOK vrd, TIP_DOK, tip_naziv, STATUS
     , ORG_DEO mag,BROJ_DOK1 brd1, BROJ_DOK brd, GODINA god
     , PPARTNER,PRT_NAZIV
     , ZAD, RAZD
     , RABAT_IZN
----     , PROIZVOD,PRO_NAZIV,JED_MERE,VAL,cena,KOL,RABAT, porez
--     , VRED
--     , RABAT_IZN,KASA
--     , akciza_iznos
--     , (Vred-RABAT_IZN)*(1- nvl(Kasa,0)/100) + akciza_iznos PDV_OSN
--     , PDV_IZNOS,TAKSA_IZNOS
--     , (Vred-RABAT_IZN)*(1- nvl(Kasa,0)/100)+ akciza_iznos + PDV_IZNOS + taksa_iznos za_kupca
    , razlika
from
(
	Select
	       d.vrsta_dok,
	       d.status,
	       d.broj_dok, D.ORG_DEO , D.BROJ_DOK1,
	       d.Godina,d.datum_dok,d.datum_unosa,
--	       pp.Teren,pp.Naziv
	       d.PPartner, pp.naziv prt_naziv,
	       d.tip_dok, nf.naziv tip_naziv,
--	       p.grupa_proizvoda,p.posebna_grupa,
	       sd.proizvod,p.naziv pro_naziv,
	       p.Jed_mere,
	       nvl(sd.Valuta,'YUD') val,
	       sd.cena,
	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina,0),2)) 															kol,
	       sd.rabat,
	       sd.Porez,
--	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina*sd.Cena,0),2)) 													vred,
--           SUM(round(nvl(sign(ST.K_ROBE)*ST.KOLICINA*ST.K_ROBE*st.cena*
--               PDokument.ZokiUlazIzlaz(d.vrsta_Dok,d.tip_dok,sd.k_robe,'D',d.datum_dok)                             VRED --****
--              ,0)
--		                              ,
--		                              DECODE(D.PPARTNER, '206',2
--		                                               , '172',2
--		                                               , 4
--		                                    )
--	                             )

          SUM     (NVL(
	                        round(nvl(sign(SD.K_ROBE)*SD.KOLICINA*SD.FAKTOR*SD.K_ROBE*SD.cena1 *
	                                  PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,SD.K_ROBE,'D',d.datum_dok)
	                                 ,0)
		                              ,
		                              DECODE(D.PPARTNER, '206',2
		                                               , '172',2
		                                               , 4
		                                    )
	                             )
                       ,0))	                                                                                        ZAD, --****


--          SUM     (NVL(
--	                        round(nvl(sign(SD.K_ROBE)*SD.KOLICINA*SD.FAKTOR*SD.K_ROBE*SD.cena1 *
--	                                  PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,SD.K_ROBE,'P',d.datum_dok)
--	                                 ,0)
--		                              , 2
--		                                    )
--	                             )
--                       ,0))	                                                                                        RAZD, --****
--
               sum(NVL(round(nvl(sign(SD.K_ROBE)*SD.KOLICINA*DECODE(SD.VRSTA_DOK,'90',0,SD.K_ROBE)*SD.cena
                             * PDokument.ZokiUlazIzlaz(d.vrsta_dok,d.tip_dok,SD.K_ROBE,'P',d.datum_dok)
                            ,0)
                   ,2),0)
                   )                                                                                                RAZD, --****

	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina*sd.Cena*sd.Rabat/100,0),2)) 									rabat_izn,
	       Sum(Round(NVL((-1)*sd.K_Robe*sd.Kolicina*sd.Cena*(1-sd.Rabat/100)*
	           Decode( d.Tip_Kase, 'A', d.Kasa, 0 )/100,0),2)) 														kasa,
	       Sum(NVL((-1)*sd.K_Robe*sign(sd.Kolicina)*sd.Akciza,0))													akciza_iznos,
	       Sum(Round(NVL((-1)*sd.K_Robe*(sd.Kolicina*sd.Cena*(1-sd.Rabat/100-
	           Decode(d.Tip_Kase,'A',d.Kasa,0)/100)+sign(sd.Kolicina)*NVL( sd.Akciza, 0))*sd.Porez/100,0),2)) 		pdv_iznos,
	       Sum(NVL((-1)*sd.K_Robe*sd.Taksa,0))																	    taksa_iznos
	       , case when d.vrsta_dok not in ('80','90') then
    	               sum((round(cena1*faktor,4) - cena)*kolicina*k_robe)
	         end razlika
	From Dokument d,
		 (SELECT  sd1.BROJ_DOK,sd1.VRSTA_DOK,sd1.GODINA,STAVKA,
		                                   PROIZVOD,LOT_SERIJA,sd1.ROK,KOLICINA,sd1.JED_MERE,CENA,VALUTA,
		                                   LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,sd1.RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,
		                                   CENA1,Z_TROSKOVI
		                             FROM DOKUMENT D1, STAVKA_DOK SD1, proizvod p
							          WHERE (k_robe<>0 or D1.vrsta_Dok = '80') And
								      D1.Org_deo not in ( select magacin from Partner_magacin_flag) and
							          D1.DATUM_DOK between to_date('29.06.2011','dd.mm.yyyy') and to_date('30.06.2011','dd.mm.yyyy') and
								      D1.Broj_Dok = SD1.Broj_Dok And
								      D1.Vrsta_Dok = SD1.Vrsta_Dok And
								      D1.Godina = SD1.Godina And
								      p.Sifra = sD1.Proizvod and
								      p.tip_proizvoda not in (8) and
								      D1.godina = 2011 and
							          D1.org_deo = 105



		                            UNION ALL

		                            SELECT VDP.ZA_BROJ_DOK,VDP.ZA_VRSTA_DOK,VDP.ZA_GODINA,STAVKA,
		                                   PROIZVOD,LOT_SERIJA,STP.ROK,KOLICINA,STP.JED_MERE,CENA,
		                                   VALUTA,LOKACIJA,PAKOVANJE,BROJ_KOLETA,K_REZ,K_ROBE,K_OCEK,KONTROLA,FAKTOR,REALIZOVANO,STP.RABAT,POREZ,KOLICINA_KONTROLNA,AKCIZA,TAKSA,CENA1,Z_TROSKOVI
		                              FROM dokument DTP, STAVKA_DOK STP, VEZNI_DOK VDP, proizvod p
		                             WHERE VDP.VRSTA_DOK = DTP.VRSTA_DOK
		                               AND VDP.GODINA    = DTP.GODINA
		                               AND VDP.BROJ_DOK  = DTP.BROJ_DOK
		                               AND VDP.ZA_VRSTA_DOK = '90'
		                               And DTP.Vrsta_Dok = STP.Vrsta_Dok
		                               And DTP.Broj_Dok = STP.Broj_Dok
		                               And DTP.Godina = STP.Godina
								       and p.tip_proizvoda not in (8)
								       and DTP.godina = 2011
							           and DTP.org_deo = 105
							           and p.Sifra = STP.Proizvod
		                               AND STP.CENA<>round(STP.CENA1*stp.faktor,4)) SD,
	     Poslovni_Partner pp, Proizvod p, nacin_fakt nf
	Where d.Status > 0 And
--	      d.Vrsta_Dok In ( '11', '12', '13', '31', '74', '80' ) And
          (k_robe<>0 or d.vrsta_Dok = '80'  or d.vrsta_Dok = '90' ) And
	      d.Org_deo not in ( select magacin from Partner_magacin_flag) and
          D.DATUM_DOK between to_date('29.06.2011','dd.mm.yyyy') and to_date('30.06.2011','dd.mm.yyyy') and
	      sd.Vrsta_Dok = d.Vrsta_Dok And
	      sd.Broj_Dok = d.Broj_Dok And
	      sd.Godina = d.Godina And
	      pp.Sifra = d.Ppartner and
	      p.Sifra = sd.Proizvod and
	      nf.tip=d.tip_dok
--	      and (d.ppartner in(  '1583', '6151', '4997', '282', '1981', '519', '8672', '5987') ) --or d.pp_isporuke=
	      and d.godina = 2011
          and d.org_deo = 105

	--      and d.vrsta_dok=4
	Group by
	         d.vrsta_dok,
	         d.status,
--	         nvl(sd.Valuta,'YUD'),
--	         sd.cena,
	         d.broj_dok, D.ORG_DEO , D.BROJ_DOK1,
	         d.Godina,d.datum_dok,d.datum_unosa,
--	         pp.Teren,
             d.PPartner, pp.Naziv,
	         d.tip_dok,nf.naziv
--	         ,p.grupa_proizvoda, p.posebna_grupa,
--	         sd.proizvod,p.naziv,
--	         p.Jed_mere, sd.rabat, sd.Porez
)
order by datum_dok, datum_unosa --, status ,D.ORG_DEO || D.BROJ_DOK1 , to_number(D.PPARTNER)
"REM WORKSPACETAB15",DOKUMENT.sql,,84
SELECT   d.rowid,
--d.datum_dok + d.valuta_placanja,
D.*
FROM
--dokument  d
--VEZNI_DOK d
--,
--komentar d
--FROM
stavka_Dok d --,
--zavisni_troskovi d
WHERE d.godina = 2011
--and d.org_deo = 115
--and d.VRSTA_DOK = 11 and d.status = 4
and (
         ( d.VRSTA_DOK = 11 and d.broj_dok in ('10938')) --1351--
      or
------          ( d.VRSTA_DOK =14 And substr(d.BROJ_DOK,1,5) in('10397')) --1351--
--      or
          ( d.VRSTA_DOK = 10 And d.BROJ_DOK in('9688')) --1351--
--      or
--          ( d.VRSTA_DOK = 32 And d.BROJ_DOK in('1')) --1351--
----
----
    )
and proizvod in (20805)
--  and org_deo = 11

--  and d.org_deo in (312)
--  and datum_dok = to_date('04.09.2009','dd.mm.yyyy')
----and stavka = 3
----  and
----      (
------          ( d.vrsta_dok  in (73)  )
----                   (d.vrsta_dok  = 11 and d.broj_dok in(14014,14015) )
--       or
--         (d.vrsta_dok  = 3 and d.tip_dok = 116)

----d.vrsta_dok = 3
----        or
----          ( d.vrsta_dok  = 3 and broj_dok in (6666) )
--       )
----  and d.godina    = vd.godina and d.vrsta_dok = vd.vrsta_dok and d.broj_dok  = vd.broj_dok and vd.za_vrsta_dok = 14
--And d.broJ_dok in (9021)
--AND D.DATUM_VALUTE IS NULL
-- ORG_DEO = 67
--And d.broJ_dok1 in (507,508,524)
--and to_char(datum_unosa, >
-- 21101 -- 18379
--and tip_dok = 222
--and status = 0
--and datum_dok > to_date('17.04.2008','dd.mm.yyyy')

--order by to_number(broj_dok1)

--union
--
--SELECT --D.BROJ_DOK
--       d.rowid , --d.* , pposlovnipartner.naziv(d.ppartner)--max (to_number(broj_dok1))--d.ROWID ,
--       d.* --spec_rabat , VRSTA_DOK , BROJ_DOK , org_deo , broj_dok1 ,DATUM_DOK , mesto_Isporuke, poslovnica
--FROM DOKUMENT  d
--WHERE d.GODINA       = 2007
--  AND d.VRSTA_DOK    = 11
--  And d.broj_dok     in ( 18360 )
----  AND  d.broj_dok1     in (351,352,354,355,357)
----  and  d.org_deo = 445
--
--AND PPARTNER = '1803'
--AND PROIZVOD in(4199)
--order by stavka
----order by to_number(broj_dok1)
--order by to_number (proizvod )
--                                                26.01.2008 19:16:55
--                                                11.02.2008 16:17:21 PS

-- za proizvod 4928 :  176.85921348314606741573033707865
-- za proizvod 4929 :  156.83375218150087260034904013962
-- za proizvod 4930 :  121.66043195063421323277339732602
-- za proizvod 4931 :  121.66043195063421323277339732602

--order by to_number(proizvod)


--and REALIZOVANO <> kolicina
